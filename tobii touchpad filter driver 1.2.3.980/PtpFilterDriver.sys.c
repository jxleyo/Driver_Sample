/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall sub_140001000(_QWORD *a1);
_QWORD *__fastcall sub_140001038(_QWORD *a1);
void __fastcall sub_140001058(__int64 **a1, __int64 a2, _BYTE *a3);
__int64 __fastcall sub_1400010B4(__int64 a1, unsigned __int16 a2, const void *a3, unsigned int a4, int a5);
void __fastcall sub_14000124C(__int64 **a1);
__int64 *__fastcall sub_140001278(__int64 **a1);
__int64 __fastcall sub_14000129C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5);
__int64 __fastcall sub_14000135C(__int64 a1);
__int64 __fastcall sub_140001810(__int64 a1);
__int64 sub_1400019C0(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 __fastcall sub_140001AB0(__int64 a1, unsigned __int8 a2, __int64 *a3, __int64 a4);
LONGLONG sub_140001AF4();
__int64 __fastcall sub_140001B1C(unsigned int a1, __int64 a2, __int64 a3, unsigned int a4, void *Dst, size_t Size);
__int64 __fastcall sub_140001CFC(__int64 a1);
__int64 __fastcall sub_140002040(__int64 a1, unsigned int *a2, _BYTE *a3);
__int64 __fastcall sub_1400021FC(__int64 a1, unsigned __int16 a2, __int64 a3, unsigned __int16 a4);
__int64 __fastcall sub_1400022A8(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_140002354(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_140002400(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
int __fastcall sub_1400024AC(__int64 a1, __int64 **a2);
NTSTATUS __fastcall sub_140002708(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
NTSTATUS __fastcall sub_14000274C(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_140002790(__int64 a1);
__int64 __fastcall sub_140002DB8(__int64 a1);
__int64 sub_140003020(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
void sub_140003134(char *Format, ...);
__int64 __fastcall sub_140003270(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, const char *a6);
__int64 __fastcall sub_1400033B0(__int64 a1, unsigned int a2, const void *a3, size_t a4);
__int64 __fastcall sub_1400034B8(const void *a1, const void *a2, unsigned int a3, __int64 a4, int a5);
__int64 __fastcall sub_1400039F0(const void *a1, const void *a2);
__int64 __fastcall sub_140003C1C(__int64 a1, __int64 a2, __int64 a3, int a4);
__int64 sub_140003DF8(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 sub_140003F0C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 __fastcall sub_1400040A4(__int64 a1, __int64 a2, __int64 a3);
__int64 __fastcall sub_14000428C(_QWORD *a1, __int64 a2);
__int64 __fastcall sub_140004538(__int64 a1);
__int64 __fastcall sub_140004658(__int64 a1, int a2);
__int64 __fastcall sub_1400048B8(__int64 a1, const void *a2, size_t a3);
__int64 __fastcall sub_1400049B8(__int64 a1);
__int64 __fastcall sub_140004AC8(__int64 a1);
__int64 __fastcall sub_140004AF8(__int64 a1, int a2);
__int64 __fastcall sub_140004C74(__int64 a1);
void __fastcall sub_140004F80(__int64 a1, unsigned int a2, _BYTE *a3);
bool __fastcall sub_140005060(__int64 a1, unsigned int a2);
__int64 __fastcall sub_140005360(__int64 a1, _BYTE *a2);
__int64 __fastcall sub_1400053F0(__int64 a1, __int64 a2, __int64 a3, __int64 a4);
__int64 __fastcall sub_140005608(__int64 a1, __int64 a2, _BYTE *a3);
__int64 __fastcall sub_140005798(unsigned __int8 *a1);
__int64 __fastcall sub_140005A3C(__int64 a1);
__int64 __fastcall sub_140005B14(__int64 a1, unsigned int a2);
__int64 __fastcall sub_140005C88(char a1, char a2, int a3, int a4);
__int64 __fastcall sub_140005D5C(__int16 a1);
// NTSTATUS __stdcall HidP_GetCaps(PHIDP_PREPARSED_DATA PreparsedData, PHIDP_CAPS Capabilities);
// NTSTATUS __stdcall HidP_GetLinkCollectionNodes(PHIDP_LINK_COLLECTION_NODE LinkCollectionNodes, PULONG LinkCollectionNodesLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetSpecificValueCaps(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, PHIDP_VALUE_CAPS ValueCaps, PUSHORT ValueCapsLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetValueCaps(HIDP_REPORT_TYPE ReportType, PHIDP_VALUE_CAPS ValueCaps, PUSHORT ValueCapsLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetUsages(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, PUSAGE UsageList, PULONG UsageLength, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// NTSTATUS __stdcall HidP_SetUsageValue(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, ULONG UsageValue, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// NTSTATUS __stdcall HidP_GetUsageValue(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, PULONG UsageValue, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// ULONG DbgPrint(PCSTR Format, ...);
__int64 __fastcall sub_140005E20(__int64 a1, __int64 a2);
// int __cdecl vsnprintf(char *Dest, size_t Count, const char *Format, va_list Args);
__int64 sub_140005E88();
NTSTATUS __stdcall DriverEntry(_DRIVER_OBJECT *DriverObject, PUNICODE_STRING RegistryPath);
__int64 __fastcall sub_14000600C(); // weak
__int64 sub_140006014();
__int64 sub_14000603C();
__int64 __fastcall sub_1400060A8(__int64 a1);
void *__fastcall sub_140006140(__int64 a1);
// __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD); weak
// __int64 __fastcall WppAutoLogStart(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WppAutoLogStop(_QWORD, _QWORD); weak
// __int64 __fastcall imp_WppRecorderReplay(_QWORD, _QWORD, _QWORD, _QWORD); weak
char __fastcall sub_1400061D0(__int64 a1, int a2);
void __fastcall sub_140006200(__int64 a1, __int64 a2, _BYTE *a3, int a4, void (*a5)(const char *, ...));
void *__fastcall sub_14000623C(_DWORD *a1, int a2, int a3, __int64 (__fastcall *a4)(const char *));
__int64 __fastcall sub_140006270(__int64 a1, int a2);
char __fastcall sub_1400062B4(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...));
__int64 __fastcall sub_140006340(__int64 a1, int a2);
__int64 __fastcall sub_140006368(unsigned int a1, unsigned int *a2);
void *__fastcall sub_140006380(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *));
void __fastcall sub_14000643C(unsigned int *a1, unsigned int *a2, void (*a3)(const char *, ...));
__int64 __fastcall sub_1400064BC(__int64 a1);
__int64 __fastcall sub_1400064DC(__int64 a1, __int64 *a2, int a3, int a4, void (__fastcall *a5)(const char *));
__int64 __fastcall sub_14000652C(__int64 a1, __int64 *a2);
__int64 __fastcall sub_14000653C(__int64 a1, __int64 *a2);
void __fastcall sub_14000656C(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...));
__int64 __fastcall sub_1400065E4(__int64 a1, _DWORD *a2);
void *__fastcall sub_1400065F0(_DWORD *a1, __int64 (__fastcall *a2)(const char *));
__int64 __fastcall sub_140006634(__int64 a1, __int64 a2, _BYTE *a3);
__int64 __fastcall sub_1400066E0(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *));
void __fastcall sub_140006750(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *));
void *__fastcall sub_1400068A4(_DWORD *a1, void (__fastcall *a2)(const char *));
__int64 __fastcall sub_1400068E4(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *));
void __fastcall sub_140006978(__int64 a1, __int64 a2, void (*a3)(const char *, ...));
void *__fastcall sub_140006BB4(_DWORD *a1, void (__fastcall *a2)(const char *));
__int64 __fastcall sub_140006BF8(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *));
// __int64 __fastcall WdfVersionBind(_QWORD, _QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionUnbind(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionBindClass(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionUnbindClass(_QWORD, _QWORD, _QWORD); weak
// void *__cdecl memmove(void *Dst, const void *Src, size_t MaxCount);
// void *__cdecl memset(void *Dst, int Val, size_t Size);
// LARGE_INTEGER __stdcall KeQueryPerformanceCounter(PLARGE_INTEGER PerformanceFrequency);
// NTSTATUS __stdcall IoWMIRegistrationControl(PDEVICE_OBJECT DeviceObject, ULONG Action);
// PVOID __stdcall MmGetSystemRoutineAddress(PUNICODE_STRING SystemRoutineName);
// void __stdcall RtlCopyUnicodeString(PUNICODE_STRING DestinationString, PCUNICODE_STRING SourceString);
// void __stdcall RtlInitUnicodeString(PUNICODE_STRING DestinationString, PCWSTR SourceString);
// void __stdcall ExFreePoolWithTag(PVOID P, ULONG Tag);
// PVOID __stdcall ExAllocatePoolWithTag(POOL_TYPE PoolType, SIZE_T NumberOfBytes, ULONG Tag);
// SIZE_T __stdcall RtlCompareMemory(const void *Source1, const void *Source2, SIZE_T Length);
__int64 __fastcall sub_14000C000(__int64 a1);
__int64 __fastcall sub_14000C52C(__int64 a1, __int64 a2);
void __fastcall sub_14000C5F0(__int64 a1);
void __fastcall sub_14000C670(__int64 a1);
void __fastcall sub_14000C6F4(__int64 a1, __int64 a2);
__int64 (*sub_14000C79C())(void);
__int64 __fastcall sub_14000C894(unsigned __int8 a1, __int64 a2, unsigned int a3, unsigned int *a4, __int64 a5, unsigned int *a6);
__int64 __fastcall sub_14000D000(__int64 a1, __int64 a2);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_140009100; // weak
_UNKNOWN unk_140009120; // weak
_UNKNOWN unk_140009130; // weak
_UNKNOWN unk_140009140; // weak
_UNKNOWN unk_140009150; // weak
_UNKNOWN unk_140009160; // weak
_UNKNOWN unk_140009170; // weak
_UNKNOWN unk_140009180; // weak
_UNKNOWN unk_140009190; // weak
_UNKNOWN unk_1400091A0; // weak
_WORD word_1400091B0[24] =
{
  5,
  5,
  6,
  6,
  7,
  7,
  8,
  -8,
  9,
  -7,
  10,
  -6,
  11,
  -5,
  12,
  -4,
  13,
  -3,
  14,
  -2,
  15,
  -1,
  0,
  0
}; // idb
_DWORD dword_1400091E0[6] = { 0, 1, 2, 3, 4, 0 }; // idb
void *off_14000A018 = &unk_14000A000; // weak
PDEVICE_OBJECT DeviceObject = &DeviceObject; // idb
_UNKNOWN unk_14000A040; // weak
_UNKNOWN unk_14000A070; // weak
_QWORD qword_14000A080 = 0i64; // idb
void *off_14000A088 = &unk_14000A070; // weak
_UNKNOWN unk_14000A090; // weak
_UNKNOWN unk_14000A0A0; // weak
__int64 (__fastcall *qword_14000A0C0)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (*qword_14000A0D0)(void) = NULL; // weak
__int64 (__fastcall *qword_14000A0D8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (__fastcall *qword_14000A0E0)(_QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
int dword_14000A0E8 = 0; // weak
struct _UNICODE_STRING DestinationString = { 0u, 0u, NULL }; // idb
__int64 (*qword_14000A108)(void) = NULL; // weak
__int64 qword_14000A110 = 0i64; // weak
__int64 qword_14000A118 = 0i64; // weak
__int64 qword_14000A120 = 0i64; // weak
__int64 qword_14000A128 = 0i64; // weak
_UNKNOWN unk_14000A130; // weak
struct _DEVICE_OBJECT stru_14000A340; // idb


//----- (0000000140001000) ----------------------------------------------------
void __fastcall sub_140001000(_QWORD *a1)
{
  void *v2; // rcx

  v2 = (void *)a1[3];
  if ( v2 )
  {
    ExFreePoolWithTag(v2, 0x50747046u);
    a1[3] = 0i64;
  }
  ExFreePoolWithTag(a1, 0x50747046u);
}

//----- (0000000140001038) ----------------------------------------------------
_QWORD *__fastcall sub_140001038(_QWORD *a1)
{
  _QWORD *result; // rax

  a1[117] = a1 + 116;
  a1[116] = a1 + 116;
  result = a1 + 118;
  a1[119] = a1 + 118;
  a1[118] = a1 + 118;
  return result;
}

//----- (0000000140001058) ----------------------------------------------------
void __fastcall sub_140001058(__int64 **a1, __int64 a2, _BYTE *a3)
{
  __int64 *v6; // rax
  __int64 **v7; // rcx

  for ( ; *a1 != (__int64 *)a1; *(_QWORD *)(a2 + 8) = v6 )
  {
    v6 = sub_140001278(a1);
    v7 = *(__int64 ***)(a2 + 8);
    if ( *v7 != (__int64 *)a2 )
      __fastfail(3u);
    *v6 = a2;
    v6[1] = (__int64)v7;
    *v7 = v6;
  }
  *a3 = 1;
}

//----- (00000001400010B4) ----------------------------------------------------
__int64 __fastcall sub_1400010B4(__int64 a1, unsigned __int16 a2, const void *a3, unsigned int a4, int a5)
{
  size_t v6; // rbp
  unsigned int v9; // esi
  PVOID v10; // rbx
  PVOID v11; // rax
  _QWORD *v12; // rax

  v6 = a4;
  v9 = 0;
  v10 = ExAllocatePoolWithTag((POOL_TYPE)512, 0x20ui64, 0x50747046u);
  if ( v10 )
  {
    v11 = ExAllocatePoolWithTag((POOL_TYPE)512, a2, 0x50747046u);
    *((_QWORD *)v10 + 3) = v11;
    if ( v11 )
    {
      memset(v11, 0, a2);
      if ( a2 >= (unsigned int)v6 )
        memmove(*((void **)v10 + 3), a3, v6);
      *((_DWORD *)v10 + 4) = a5;
      v12 = *(_QWORD **)(a1 + 8);
      if ( *v12 != a1 )
        __fastfail(3u);
      *(_QWORD *)v10 = a1;
      *((_QWORD *)v10 + 1) = v12;
      *v12 = v10;
      *(_QWORD *)(a1 + 8) = v10;
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PTPFilterBufferStoreReport");
      DbgPrint("ExAllocatePoolWithTag for input report failed");
      DbgPrint("\n");
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 1u, 0xBu, (__int64)&unk_140009130);
      v9 = -1073741664;
      ExFreePoolWithTag(v10, 0x50747046u);
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterBufferStoreReport");
    DbgPrint("ExAllocatePoolWithTag for list entry failed");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 1u, 0xAu, (__int64)&unk_140009130);
    v9 = -1073741664;
  }
  return v9;
}

//----- (000000014000124C) ----------------------------------------------------
void __fastcall sub_14000124C(__int64 **a1)
{
  __int64 *v2; // rax

  while ( *a1 != (__int64 *)a1 )
  {
    v2 = sub_140001278(a1);
    sub_140001000(v2);
  }
}

//----- (0000000140001278) ----------------------------------------------------
__int64 *__fastcall sub_140001278(__int64 **a1)
{
  __int64 *result; // rax
  __int64 *v2; // rdx

  result = *a1;
  if ( (__int64 **)(*a1)[1] != a1 || (v2 = (__int64 *)*result, *(__int64 **)(*result + 8) != result) )
    __fastfail(3u);
  *a1 = v2;
  v2[1] = (__int64)a1;
  return result;
}

//----- (000000014000129C) ----------------------------------------------------
__int64 __fastcall sub_14000129C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-28h]

  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, 0i64);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, 0i64);
}
// 14000133D: variable 'v12' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (000000014000135C) ----------------------------------------------------
__int64 __fastcall sub_14000135C(__int64 a1)
{
  __int64 v1; // rbx
  _QWORD *v2; // r14
  _QWORD *v3; // rsi
  int v4; // edi
  __int64 v5; // rcx
  __int64 v6; // rdx
  __int64 v8; // [rsp+28h] [rbp-58h]
  _QWORD Dst[8]; // [rsp+40h] [rbp-40h] BYREF

  v1 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         a1,
         off_14000A018);
  v2 = (_QWORD *)(v1 + 768);
  v3 = (_QWORD *)(v1 + 776);
  *(_QWORD *)(v1 + 768) = 0i64;
  *(_QWORD *)(v1 + 776) = 0i64;
  DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x13u, (__int64)&unk_140009140);
  v4 = sub_140002790(v1);
  if ( v4 >= 0 )
  {
    memset(Dst, 0, 0x38ui64);
    Dst[3] = 0x100000001i64;
    LODWORD(Dst[0]) = 56;
    Dst[4] = *(_QWORD *)(v1 + 8);
    v4 = (*(__int64 (__fastcall **)(__int64, _QWORD *, _QWORD, _QWORD *))(qword_14000A118 + 1976))(
           qword_14000A110,
           Dst,
           0i64,
           v2);
    if ( v4 >= 0 )
    {
      memset(Dst, 0, 0x38ui64);
      LODWORD(Dst[0]) = 56;
      Dst[3] = 0x100000001i64;
      Dst[4] = *(_QWORD *)(v1 + 8);
      v5 = *(unsigned __int16 *)(v1 + 812);
      *(_DWORD *)(v1 + 792) = v5;
      if ( (_WORD)v5 )
      {
        v4 = (*(__int64 (__fastcall **)(__int64, _QWORD *, __int64, __int64, __int64, _QWORD *, __int64))(qword_14000A118 + 1536))(
               qword_14000A110,
               Dst,
               512i64,
               1349808198i64,
               v5,
               v3,
               v1 + 784);
        if ( v4 >= 0 )
        {
          if ( *(_BYTE *)(v1 + 920) == 1 )
          {
            DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
            DbgPrint("Restart read loop");
            DbgPrint("\n");
            sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x18u, (__int64)&unk_140009140);
            v4 = sub_14000428C((_QWORD *)v1, (__int64)sub_1400053F0);
            if ( v4 >= 0 )
            {
              *(_BYTE *)(v1 + 920) = 0;
              *(_BYTE *)(v1 + 908) = 1;
            }
            else
            {
              DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
              DbgPrint("PrepareHardware SendReadRequest failed unexpectedly 0x%x", (unsigned int)v4);
              DbgPrint("\n");
              LODWORD(v8) = v4;
              sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x19u, (__int64)&unk_140009140, v8);
              *(_BYTE *)(v1 + 908) = 0;
            }
          }
          else
          {
            v6 = *(_QWORD *)(v1 + 880);
            *(_DWORD *)(v1 + 4) = 0;
            *(_BYTE *)v1 = 0;
            sub_140006380(v1 + 64, v6, (void (__fastcall *)(const char *))sub_140003134);
          }
        }
        else
        {
          DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
          DbgPrint("WdfMemoryCreate failed 0x%x", (unsigned int)v4);
          DbgPrint("\n");
          LODWORD(v8) = v4;
          sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x17u, (__int64)&unk_140009140, v8);
          *v3 = 0i64;
        }
      }
      else
      {
        DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
        DbgPrint("InputReportByteLength is 0");
        DbgPrint("\n");
        sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x16u, (__int64)&unk_140009140);
      }
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
      DbgPrint("WdfRequestCreate failed 0x%x", (unsigned int)v4);
      DbgPrint("\n");
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x15u, (__int64)&unk_140009140, v4);
      *v2 = 0i64;
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
    DbgPrint("GetDeviceProperties failed 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x14u, (__int64)&unk_140009140, v4);
  }
  if ( v4 < 0 )
  {
    if ( *v2 )
    {
      (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);
      *v2 = 0i64;
    }
    if ( *v3 )
    {
      (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);
      *v3 = 0i64;
      *(_QWORD *)(v1 + 784) = 0i64;
    }
  }
  DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x1Au, (__int64)&unk_140009140);
  return (unsigned int)v4;
}
// 14000163E: variable 'v8' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140001810) ----------------------------------------------------
__int64 __fastcall sub_140001810(__int64 a1)
{
  __int64 v2; // rbx
  void *v3; // rcx
  void *v4; // rcx

  DbgPrint("[PTP] %s : ", "PTPFilterDeviceReleaseHardware");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x1Bu, (__int64)&unk_140009140);
  v2 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         a1,
         off_14000A018);
  *(_BYTE *)(v2 + 920) = 1;
  sub_14000124C((__int64 **)(v2 + 928));
  sub_14000124C((__int64 **)(v2 + 944));
  if ( *(_QWORD *)(v2 + 768) )
  {
    (*(void (__fastcall **)(__int64))(qword_14000A118 + 2064))(qword_14000A110);
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 1664))(qword_14000A110, *(_QWORD *)(v2 + 768));
    *(_QWORD *)(v2 + 768) = 0i64;
  }
  if ( *(_QWORD *)(v2 + 776) )
  {
    (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);
    *(_QWORD *)(v2 + 776) = 0i64;
    *(_QWORD *)(v2 + 784) = 0i64;
  }
  v3 = *(void **)(v2 + 800);
  if ( v3 )
  {
    ExFreePoolWithTag(v3, 0x50747046u);
    *(_QWORD *)(v2 + 800) = 0i64;
  }
  v4 = *(void **)(v2 + 872);
  if ( v4 )
  {
    ExFreePoolWithTag(v4, 0x50747046u);
    *(_QWORD *)(v2 + 872) = 0i64;
  }
  DbgPrint("[PTP] %s : ", "PTPFilterDeviceReleaseHardware");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x1Cu, (__int64)&unk_140009140);
  return 0i64;
}
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400019C0) ----------------------------------------------------
__int64 sub_1400019C0(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-38h]
  va_list va; // [rsp+88h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140001A90: variable 'v12' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140001AB0) ----------------------------------------------------
__int64 __fastcall sub_140001AB0(__int64 a1, unsigned __int8 a2, __int64 *a3, __int64 a4)
{
  __int64 result; // rax
  __int64 v5; // rdx

  if ( a2 <= 1u )
  {
    result = 0i64;
    if ( a2 )
    {
      *(_DWORD *)(a4 + 44) = *((_DWORD *)a3 + 1);
      *(_BYTE *)(a4 + 41) = *((_BYTE *)a3 + 2);
      v5 = *a3;
      *(_QWORD *)(a4 + 24) = *a3;
      LOBYTE(a4) = *((_BYTE *)a3 + 2);
      result = imp_WppRecorderReplay(DeviceObject, v5, *((unsigned int *)a3 + 1), a4);
    }
    else
    {
      *(_BYTE *)(a4 + 41) = 0;
      *(_DWORD *)(a4 + 44) = 0;
      *(_QWORD *)(a4 + 24) = 0i64;
    }
  }
  return result;
}
// 1400061C9: using guessed type __int64 __fastcall imp_WppRecorderReplay(_QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140001AF4) ----------------------------------------------------
LONGLONG sub_140001AF4()
{
  __int128 v1; // rtt
  union _LARGE_INTEGER PerformanceFrequency; // [rsp+30h] [rbp+8h] BYREF

  PerformanceFrequency.QuadPart = 0i64;
  v1 = 1000i64 * *(_QWORD *)&KeQueryPerformanceCounter(&PerformanceFrequency);
  return v1 / PerformanceFrequency.QuadPart;
}

//----- (0000000140001B1C) ----------------------------------------------------
__int64 __fastcall sub_140001B1C(unsigned int a1, __int64 a2, __int64 a3, unsigned int a4, void *Dst, size_t Size)
{
  __int64 *v7; // rsi
  __int64 *v8; // r14
  unsigned int v12; // ebx
  __int64 v14; // [rsp+40h] [rbp-39h] BYREF
  __int64 v15; // [rsp+48h] [rbp-31h]
  __int64 v16; // [rsp+50h] [rbp-29h]
  __int64 v17; // [rsp+58h] [rbp-21h] BYREF
  void *v18; // [rsp+60h] [rbp-19h]
  __int64 v19; // [rsp+68h] [rbp-11h]
  int v20[2]; // [rsp+70h] [rbp-9h] BYREF
  __int64 v21; // [rsp+78h] [rbp-1h]

  v14 = 0i64;
  v15 = 0i64;
  v7 = 0i64;
  v16 = 0i64;
  v8 = 0i64;
  v17 = 0i64;
  v18 = 0i64;
  v19 = 0i64;
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterCallHidClassSynchronously");
    DbgPrint("Entry");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xEu, (__int64)&unk_140009160);
  }
  if ( a3 )
  {
    v14 = 1i64;
    v7 = &v14;
    v15 = a3;
    v16 = a4;
  }
  if ( Dst )
  {
    memset(Dst, 0, (unsigned int)Size);
    v17 = 1i64;
    v8 = &v17;
    v18 = Dst;
    v19 = (unsigned int)Size;
  }
  v20[0] = 16;
  v20[1] = 3;
  v21 = -10000000i64;
  v12 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD, _QWORD, __int64 *, __int64 *, int *, _QWORD, __int64, __int64, __int64, __int64, void *, __int64))(qword_14000A118 + 1488))(
          qword_14000A110,
          a2,
          0i64,
          a1,
          v7,
          v8,
          v20,
          0i64,
          v14,
          v15,
          v16,
          v17,
          v18,
          v19);
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterCallHidClassSynchronously");
    DbgPrint("Exit");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xFu, (__int64)&unk_140009160);
  }
  return v12;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140001CFC) ----------------------------------------------------
__int64 __fastcall sub_140001CFC(__int64 a1)
{
  __int64 v1; // r12
  __int128 v2; // xmm0
  __int128 v4; // xmm1
  __int128 v5; // xmm0
  __int128 v6; // xmm1
  __int128 v7; // xmm0
  __int128 v8; // xmm1
  __int128 v9; // xmm0
  __int128 v10; // xmm1
  __int128 v11; // xmm0
  __int64 v12; // r14
  __int64 *v13; // rdi
  ULONG v14; // er15
  unsigned __int16 v15; // si
  CHAR *v16; // r13
  USHORT v17; // r14
  __int64 result; // rax
  __int64 v19; // rsi
  USHORT *v20; // r9
  ULONG v21; // edx
  __int64 v22; // r15
  __int16 v23; // r8
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+30h] [rbp-D8h]
  PCHAR Report; // [rsp+38h] [rbp-D0h]
  __int16 v26; // [rsp+48h] [rbp-C0h]
  ULONG v27; // [rsp+4Ch] [rbp-BCh] BYREF
  int v28; // [rsp+50h] [rbp-B8h]
  ULONG UsageLength; // [rsp+54h] [rbp-B4h] BYREF
  ULONG UsageValue[2]; // [rsp+58h] [rbp-B0h] BYREF
  LONGLONG v31; // [rsp+60h] [rbp-A8h]
  _OWORD v32[10]; // [rsp+68h] [rbp-A0h] BYREF

  v1 = a1 + 600;
  v2 = *(_OWORD *)(a1 + 600);
  v4 = *(_OWORD *)(a1 + 616);
  LOWORD(v28) = *(_WORD *)(a1 + 592);
  v32[0] = v2;
  v5 = *(_OWORD *)(a1 + 632);
  v32[1] = v4;
  v6 = *(_OWORD *)(a1 + 648);
  v32[2] = v5;
  v7 = *(_OWORD *)(a1 + 664);
  v32[3] = v6;
  v8 = *(_OWORD *)(a1 + 680);
  v32[4] = v7;
  v9 = *(_OWORD *)(a1 + 696);
  v32[5] = v8;
  v10 = *(_OWORD *)(a1 + 728);
  v32[6] = v9;
  v32[7] = *(_OWORD *)(a1 + 712);
  v11 = *(_OWORD *)(a1 + 744);
  v32[8] = v10;
  v32[9] = v11;
  memset((void *)(a1 + 600), 0, 0xA0ui64);
  v12 = a1 + 928;
  v13 = *(__int64 **)(a1 + 928);
  *(_WORD *)(a1 + 592) = *(_WORD *)(a1 + 904);
  v14 = 0;
  v27 = 0;
  v15 = 0;
  v26 = 0;
  v31 = sub_140001AF4();
  while ( 1 )
  {
    if ( v13 == (__int64 *)v12 )
      return v14;
    v16 = (CHAR *)v13[3];
    if ( *((_DWORD *)v13 + 4) )
      break;
LABEL_19:
    sub_1400021FC(v1, *((_WORD *)v13 + 8), (__int64)v32, v28);
    v13 = (__int64 *)*v13;
  }
  v17 = 1;
  while ( 1 )
  {
    result = sub_1400022A8(&UsageValue[1], v17, v16, a1);
    if ( (int)result < 0 )
      return result;
    v19 = 32i64 * v15;
    *(_WORD *)(v19 + v1 + 24) = UsageValue[1];
    result = sub_140002354(&v27, v17, v16, a1);
    if ( (int)result < 0 )
      return result;
    *(_DWORD *)(v19 + v1) = v27 * *(_DWORD *)(a1 + 888);
    result = sub_140002400(&v27, v17, v16, a1);
    if ( (int)result < 0 )
      return result;
    *(_DWORD *)(v19 + v1 + 4) = v27 * *(_DWORD *)(a1 + 892);
    v20 = *(USHORT **)(a1 + 872);
    UsageLength = *(unsigned __int16 *)(a1 + 854);
    UsageValue[0] = HidP_GetUsages(
                      HidP_Input,
                      0xDu,
                      0,
                      v20,
                      &UsageLength,
                      *(PHIDP_PREPARSED_DATA *)(a1 + 800),
                      v16,
                      *(_DWORD *)(a1 + 792));
    v14 = UsageValue[0];
    if ( UsageValue[0] == 1114112 )
    {
      v21 = UsageLength;
      v22 = 0i64;
      if ( UsageLength )
      {
        do
        {
          v23 = *(_WORD *)(*(_QWORD *)(a1 + 872) + 2 * v22);
          if ( v23 == 66 )
          {
            *(_DWORD *)(v19 + v1 + 8) = 1;
          }
          else if ( v23 != 71 )
          {
            DbgPrint("[PTP] %s : ", "PTPFilterCreateContactsFromHidReport");
            DbgPrint(
              "output5: button usage[%d]: 0x%02x",
              (unsigned int)v22,
              *(unsigned __int16 *)(*(_QWORD *)(a1 + 872) + 2 * v22));
            DbgPrint("\n");
            LODWORD(Report) = *(unsigned __int16 *)(*(_QWORD *)(a1 + 872) + 2 * v22);
            LODWORD(PreparsedData) = v22;
            sub_140003020(
              (__int64)DeviceObject->DeviceExtension,
              4u,
              4u,
              0x29u,
              (__int64)&unk_140009160,
              PreparsedData,
              Report);
            v21 = UsageLength;
          }
          v22 = (unsigned int)(v22 + 1);
        }
        while ( (unsigned int)v22 < v21 );
        v14 = UsageValue[0];
      }
      else
      {
        v14 = 1114112;
      }
    }
    *(_QWORD *)(v19 + v1 + 16) = v31;
    ++v17;
    v15 = ++v26;
    if ( (unsigned int)(unsigned __int16)(v17 - 1) >= *((_DWORD *)v13 + 4) )
    {
      v12 = a1 + 928;
      goto LABEL_19;
    }
  }
}
// 140001F96: variable 'PreparsedData' is possibly undefined
// 140001F96: variable 'Report' is possibly undefined

//----- (0000000140002040) ----------------------------------------------------
__int64 __fastcall sub_140002040(__int64 a1, unsigned int *a2, _BYTE *a3)
{
  unsigned int v6; // edi
  int v7; // ecx
  unsigned __int16 v8; // r9
  unsigned int v9; // eax
  unsigned int v10; // ecx
  __int64 v12; // [rsp+28h] [rbp-20h]
  ULONG v13; // [rsp+50h] [rbp+8h] BYREF

  *a3 = 0;
  v6 = HidP_GetUsageValue(
         HidP_Input,
         0xDu,
         0,
         0x54u,
         &v13,
         *(PHIDP_PREPARSED_DATA *)(a1 + 800),
         *(PCHAR *)(a1 + 784),
         *(_DWORD *)(a1 + 792));
  if ( (v6 & 0x80000000) != 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
    DbgPrint("Could not obtain actual count from OEM HID report - 0x%x", v6);
    DbgPrint("\n");
    LODWORD(v12) = v6;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Cu, (__int64)&unk_140009160, v12);
    return v6;
  }
  v7 = *(_DWORD *)(a1 + 900);
  if ( v7 )
  {
    if ( v13 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
      DbgPrint("Expected report with 0 actual count in OEM HID report");
      DbgPrint("\n");
      v8 = 29;
LABEL_6:
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 4u, v8, (__int64)&unk_140009160);
      return (unsigned int)-1073739509;
    }
  }
  else
  {
    if ( !v13 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
      DbgPrint("Non-zero actual count expected in OEM HID report");
      DbgPrint("\n");
      v8 = 30;
      goto LABEL_6;
    }
    *(_DWORD *)(a1 + 904) = v13;
  }
  v9 = *(_DWORD *)(a1 + 904) - v7;
  v10 = *(_DWORD *)(a1 + 896);
  if ( v10 >= v9 )
    v10 = v9;
  *a2 = v10;
  *(_DWORD *)(a1 + 900) += v10;
  if ( *(_DWORD *)(a1 + 900) == *(_DWORD *)(a1 + 904) )
    *a3 = 1;
  return v6;
}
// 1400020F8: variable 'v12' is possibly undefined

//----- (00000001400021FC) ----------------------------------------------------
__int64 __fastcall sub_1400021FC(__int64 a1, unsigned __int16 a2, __int64 a3, unsigned __int16 a4)
{
  unsigned __int16 v4; // r10
  unsigned __int16 i; // r11
  unsigned __int16 v8; // cx
  __int64 result; // rax
  __int64 v10; // rdx
  __int128 v11; // xmm2
  __int128 v12; // xmm3

  v4 = 0;
  for ( i = 0; i < a4; ++i )
  {
    v8 = v4;
    if ( v4 < a2 )
    {
      while ( 1 )
      {
        result = 32i64 * v8;
        if ( *(_WORD *)(32i64 * i + a3 + 24) == *(_WORD *)(result + a1 + 24) )
          break;
        if ( ++v8 >= a2 )
          goto LABEL_9;
      }
      if ( v8 != v4 )
      {
        result = 32i64 * v4;
        v10 = 32i64 * v8;
        v11 = *(_OWORD *)(result + a1);
        v12 = *(_OWORD *)(result + a1 + 16);
        *(_OWORD *)(result + a1) = *(_OWORD *)(v10 + a1);
        *(_OWORD *)(result + a1 + 16) = *(_OWORD *)(v10 + a1 + 16);
        *(_OWORD *)(v10 + a1) = v11;
        *(_OWORD *)(v10 + a1 + 16) = v12;
      }
      ++v4;
    }
LABEL_9:
    ;
  }
  return result;
}

//----- (00000001400022A8) ----------------------------------------------------
__int64 __fastcall sub_1400022A8(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
{
  NTSTATUS v4; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         0xDu,
         a2,
         0x51u,
         UsageValue,
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),
         Report,
         *(_DWORD *)(a4 + 792));
  if ( v4 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactId");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_CONTACTID failed with status - 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    LODWORD(PreparsedData) = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x22u, (__int64)&unk_140009160, PreparsedData);
  }
  return (unsigned int)v4;
}
// 140002347: variable 'PreparsedData' is possibly undefined

//----- (0000000140002354) ----------------------------------------------------
__int64 __fastcall sub_140002354(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
{
  NTSTATUS v4; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         1u,
         a2,
         0x30u,
         UsageValue,
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),
         Report,
         *(_DWORD *)(a4 + 792));
  if ( v4 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactTX");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_GENERIC_X failed with status - 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    LODWORD(PreparsedData) = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x23u, (__int64)&unk_140009160, PreparsedData);
  }
  return (unsigned int)v4;
}
// 1400023F3: variable 'PreparsedData' is possibly undefined

//----- (0000000140002400) ----------------------------------------------------
__int64 __fastcall sub_140002400(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
{
  NTSTATUS v4; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         1u,
         a2,
         0x31u,
         UsageValue,
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),
         Report,
         *(_DWORD *)(a4 + 792));
  if ( v4 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactTY");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_GENERIC_Y failed with status - 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    LODWORD(PreparsedData) = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x24u, (__int64)&unk_140009160, PreparsedData);
  }
  return (unsigned int)v4;
}
// 14000249F: variable 'PreparsedData' is possibly undefined

//----- (00000001400024AC) ----------------------------------------------------
int __fastcall sub_1400024AC(__int64 a1, __int64 **a2)
{
  __int64 *v2; // rbx
  _OWORD *v3; // rax
  char *v4; // r8
  int v7; // er9
  __int64 v8; // rcx
  __int128 v9; // xmm1
  __int128 v10; // xmm0
  __int128 v11; // xmm1
  __int128 v12; // xmm0
  __int128 v13; // xmm1
  __int128 v14; // xmm0
  __int128 v15; // xmm1
  __int128 v16; // xmm1
  __int128 v17; // xmm0
  __int128 v18; // xmm1
  __int128 v19; // xmm0
  __int128 v20; // xmm1
  CHAR *v21; // r15
  USHORT v22; // di
  int result; // eax
  unsigned __int16 i; // dx
  __int64 v25; // r12
  ULONG UsageValue[4]; // [rsp+30h] [rbp-228h] BYREF
  char v27; // [rsp+40h] [rbp-218h] BYREF
  int v28; // [rsp+48h] [rbp-210h]
  _OWORD v29[29]; // [rsp+50h] [rbp-208h]

  v2 = *a2;
  v3 = (_OWORD *)(a1 + 88);
  v4 = &v27;
  v7 = 0;
  v8 = 3i64;
  do
  {
    v9 = v3[1];
    *(_OWORD *)v4 = *v3;
    v10 = v3[2];
    *((_OWORD *)v4 + 1) = v9;
    v11 = v3[3];
    *((_OWORD *)v4 + 2) = v10;
    v12 = v3[4];
    *((_OWORD *)v4 + 3) = v11;
    v13 = v3[5];
    *((_OWORD *)v4 + 4) = v12;
    v14 = v3[6];
    *((_OWORD *)v4 + 5) = v13;
    v15 = v3[7];
    v3 += 8;
    *((_OWORD *)v4 + 6) = v14;
    v4 += 128;
    *((_OWORD *)v4 - 1) = v15;
    --v8;
  }
  while ( v8 );
  v16 = v3[1];
  *(_OWORD *)v4 = *v3;
  v17 = v3[2];
  *((_OWORD *)v4 + 1) = v16;
  v18 = v3[3];
  *((_OWORD *)v4 + 2) = v17;
  v19 = v3[4];
  *((_OWORD *)v4 + 3) = v18;
  v20 = v3[5];
  *((_OWORD *)v4 + 4) = v19;
  *((_OWORD *)v4 + 5) = v20;
  if ( v2 == (__int64 *)a2 )
    return v7;
  while ( 1 )
  {
    v21 = (CHAR *)v2[3];
    if ( *((_DWORD *)v2 + 4) )
      break;
LABEL_14:
    v2 = (__int64 *)*v2;
    if ( v2 == (__int64 *)a2 )
      return v7;
  }
  v22 = 1;
  while ( 1 )
  {
    result = sub_1400022A8(UsageValue, v22, v21, a1);
    if ( result < 0 )
      return result;
    for ( i = 0; i < v28; ++i )
    {
      if ( LOWORD(v29[3 * i]) == UsageValue[0] )
        break;
    }
    if ( i == v28 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterRewritePosition");
      DbgPrint("Finger with contactId %d not found in Fingers", UsageValue[0]);
      DbgPrint("\n");
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x2Au, (__int64)&unk_140009160, UsageValue[0]);
      return -1073741811;
    }
    v25 = 3i64 * i;
    result = sub_140002708(DWORD2(v29[3 * i + 2]) / *(_DWORD *)(a1 + 888), v22, v21, a1);
    if ( result != 1114112 )
      return result;
    result = sub_14000274C(HIDWORD(v29[v25 + 2]) / *(_DWORD *)(a1 + 892), v22, v21, a1);
    v7 = result;
    if ( result != 1114112 )
      return result;
    if ( (unsigned int)v22++ >= *((_DWORD *)v2 + 4) )
      goto LABEL_14;
  }
}

//----- (0000000140002708) ----------------------------------------------------
NTSTATUS __fastcall sub_140002708(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
{
  return HidP_SetUsageValue(
           HidP_Input,
           1u,
           a2,
           0x30u,
           UsageValue,
           *(PHIDP_PREPARSED_DATA *)(a4 + 800),
           Report,
           *(_DWORD *)(a4 + 792));
}

//----- (000000014000274C) ----------------------------------------------------
NTSTATUS __fastcall sub_14000274C(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
{
  return HidP_SetUsageValue(
           HidP_Input,
           1u,
           a2,
           0x31u,
           UsageValue,
           *(PHIDP_PREPARSED_DATA *)(a4 + 800),
           Report,
           *(_DWORD *)(a4 + 792));
}

//----- (0000000140002790) ----------------------------------------------------
__int64 __fastcall sub_140002790(__int64 a1)
{
  unsigned __int16 v2; // bp
  __int64 v3; // rdx
  char v4; // r12
  char v5; // r13
  int v6; // ebx
  unsigned __int16 v7; // r9
  PVOID Dst; // rax
  unsigned __int16 v9; // ax
  unsigned __int16 v10; // r9
  PVOID v11; // rax
  unsigned __int16 v12; // r9
  _WORD *v13; // r15
  unsigned __int16 v14; // ax
  struct _HIDP_VALUE_CAPS *v15; // rax
  struct _HIDP_VALUE_CAPS *v16; // rsi
  int v17; // eax
  int v18; // eax
  void *v19; // rcx
  void *v20; // rcx
  size_t Size; // [rsp+28h] [rbp-50h]
  size_t Sizea; // [rsp+28h] [rbp-50h]
  SIZE_T NumberOfBytes; // [rsp+30h] [rbp-48h] BYREF
  int v25; // [rsp+38h] [rbp-40h]

  v2 = 0;
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("Entry");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0x10u, (__int64)&unk_140009160);
  }
  v3 = *(_QWORD *)(a1 + 16);
  NumberOfBytes = 0i64;
  v25 = 0;
  LODWORD(Size) = 12;
  v4 = 0;
  v5 = 0;
  v6 = sub_140001B1C(0xB01A8u, v3, 0i64, 0, &NumberOfBytes, Size);
  if ( v6 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("CallHidClassSynchronously failed 0x%x", (unsigned int)v6);
    DbgPrint("\n");
    v7 = 17;
LABEL_5:
    LODWORD(Sizea) = v6;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, v7, (__int64)&unk_140009160, Sizea);
    goto LABEL_39;
  }
  Dst = ExAllocatePoolWithTag((POOL_TYPE)512, (unsigned int)NumberOfBytes, 0x50747046u);
  *(_QWORD *)(a1 + 800) = Dst;
  if ( Dst )
  {
    LODWORD(Sizea) = NumberOfBytes;
    v6 = sub_140001B1C(0xB0193u, *(_QWORD *)(a1 + 16), 0i64, 0, Dst, Sizea);
    if ( v6 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("PTPFilterCallHidClassSynchronously failed 0x%x", (unsigned int)v6);
      DbgPrint("\n");
      v7 = 19;
      goto LABEL_5;
    }
    v6 = HidP_GetCaps(*(PHIDP_PREPARSED_DATA *)(a1 + 800), (PHIDP_CAPS)(a1 + 808));
    if ( v6 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("HidP_GetCaps failed 0x%x", (unsigned int)v6);
      DbgPrint("\n");
      v7 = 20;
      goto LABEL_5;
    }
    v9 = *(_WORD *)(a1 + 854);
    if ( !v9 )
    {
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("NumberInputButtonCaps is 0");
      DbgPrint("\n");
      v10 = 21;
LABEL_14:
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 4u, v10, (__int64)&unk_140009160);
      goto LABEL_39;
    }
    v11 = ExAllocatePoolWithTag((POOL_TYPE)512, 2i64 * v9, 0x50747046u);
    *(_QWORD *)(a1 + 872) = v11;
    if ( v11 )
    {
      v6 = sub_140002DB8(a1);
      if ( v6 < 0 )
      {
        DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
        DbgPrint("PtpFilterGetMaxFingers failed 0x%x", (unsigned int)v6);
        DbgPrint("\n");
        v7 = 23;
        goto LABEL_5;
      }
      v13 = (_WORD *)(a1 + 856);
      v14 = *(_WORD *)(a1 + 856);
      if ( !v14 )
      {
        DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
        DbgPrint("NumberInputValueCaps is 0");
        DbgPrint("\n");
        v10 = 24;
        goto LABEL_14;
      }
      v15 = (struct _HIDP_VALUE_CAPS *)ExAllocatePoolWithTag((POOL_TYPE)512, 72i64 * v14, 0x50747046u);
      v16 = v15;
      if ( v15 )
      {
        v6 = HidP_GetValueCaps(HidP_Input, v15, (PUSHORT)(a1 + 856), *(PHIDP_PREPARSED_DATA *)(a1 + 800));
        if ( v6 >= 0 )
        {
          if ( *v13 )
          {
            do
            {
              if ( !v4 && v16[v2].Range.UsageMin == 48 && v16[v2].UsagePage == 1 )
              {
                v17 = sub_140005C88(v16[v2].UnitsExp, v16[v2].Units, v16[v2].PhysicalMax, v16[v2].PhysicalMin);
                *(_DWORD *)(a1 + 880) = v17;
                v4 = 1;
                *(_DWORD *)(a1 + 888) = v17 / (v16[v2].LogicalMax - v16[v2].LogicalMin);
              }
              if ( !v5 && v16[v2].Range.UsageMin == 49 && v16[v2].UsagePage == 1 )
              {
                v18 = sub_140005C88(v16[v2].UnitsExp, v16[v2].Units, v16[v2].PhysicalMax, v16[v2].PhysicalMin);
                *(_DWORD *)(a1 + 884) = v18;
                v5 = 1;
                *(_DWORD *)(a1 + 892) = v18 / (v16[v2].LogicalMax - v16[v2].LogicalMin);
              }
              if ( v4 && v5 )
                break;
              ++v2;
            }
            while ( v2 != *v13 );
          }
        }
        else
        {
          DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
          DbgPrint("HidP_GetValueCaps failed 0x%x", (unsigned int)v6);
          DbgPrint("\n");
          LODWORD(Sizea) = v6;
          sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Au, (__int64)&unk_140009160, Sizea);
        }
        ExFreePoolWithTag(v16, 0x50747046u);
LABEL_39:
        if ( v6 >= 0 )
          goto LABEL_44;
        goto LABEL_40;
      }
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("ExAllocatePoolWithTag for value caps failed");
      DbgPrint("\n");
      v12 = 25;
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("ExAllocatePoolWithTag for button usages failed");
      DbgPrint("\n");
      v12 = 22;
    }
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 4u, v12, (__int64)&unk_140009160);
    v6 = -1073741801;
    goto LABEL_40;
  }
  v6 = -1073741670;
  DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
  DbgPrint("ExAllocatePoolWithTag for preparsed data failed 0x%x", 3221225626i64);
  DbgPrint("\n");
  LODWORD(Sizea) = -1073741670;
  sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x12u, (__int64)&unk_140009160, Sizea);
LABEL_40:
  v19 = *(void **)(a1 + 872);
  if ( v19 )
  {
    ExFreePoolWithTag(v19, 0x50747046u);
    *(_QWORD *)(a1 + 872) = 0i64;
  }
  v20 = *(void **)(a1 + 800);
  if ( v20 )
  {
    ExFreePoolWithTag(v20, 0x50747046u);
    *(_QWORD *)(a1 + 800) = 0i64;
  }
LABEL_44:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("Exit");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0x1Bu, (__int64)&unk_140009160);
  }
  return (unsigned int)v6;
}
// 140002859: variable 'Size' is possibly undefined
// 1400028AF: variable 'Sizea' is possibly undefined

//----- (0000000140002DB8) ----------------------------------------------------
__int64 __fastcall sub_140002DB8(__int64 a1)
{
  struct _HIDP_PREPARSED_DATA *v2; // r8
  unsigned int v3; // ebx
  USHORT v4; // si
  USHORT ValueCapsLength[2]; // [rsp+40h] [rbp-88h] BYREF
  ULONG LinkCollectionNodesLength[3]; // [rsp+44h] [rbp-84h] BYREF
  struct _HIDP_VALUE_CAPS ValueCaps; // [rsp+50h] [rbp-78h] BYREF

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("Entry");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xAu, (__int64)&unk_140009160);
  }
  v2 = *(struct _HIDP_PREPARSED_DATA **)(a1 + 800);
  *(_DWORD *)(a1 + 896) = 0;
  if ( v2 )
  {
    LinkCollectionNodesLength[0] = 0;
    v3 = HidP_GetLinkCollectionNodes(0i64, LinkCollectionNodesLength, v2);
    if ( v3 == -1072627705 )
    {
      v4 = 1;
      ValueCapsLength[0] = 1;
      if ( LinkCollectionNodesLength[0] > 1 )
      {
        do
        {
          v3 = HidP_GetSpecificValueCaps(
                 HidP_Input,
                 0xDu,
                 v4,
                 0x51u,
                 &ValueCaps,
                 ValueCapsLength,
                 *(PHIDP_PREPARSED_DATA *)(a1 + 800));
          if ( v3 == 1114112 )
            ++*(_DWORD *)(a1 + 896);
          ++v4;
        }
        while ( v4 < LinkCollectionNodesLength[0] );
      }
      if ( !*(_DWORD *)(a1 + 896) )
        v3 = -1073739509;
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
      DbgPrint("HidP_GetLinkCollectionNodes failed 0x%x", v3);
      DbgPrint("\n");
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0xCu, (__int64)&unk_140009160, v3);
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("HIDPreparsedData is NULL");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0xBu, (__int64)&unk_140009160);
    v3 = -1073741811;
  }
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("Exit");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xDu, (__int64)&unk_140009160);
  }
  return v3;
}

//----- (0000000140003020) ----------------------------------------------------
__int64 sub_140003020(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-48h]
  va_list va; // [rsp+98h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140003114: variable 'v12' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140003134) ----------------------------------------------------
void sub_140003134(char *Format, ...)
{
  int v1; // ebx
  int v2; // eax
  char Dest[511]; // [rsp+30h] [rbp-228h] BYREF
  char v4; // [rsp+22Fh] [rbp-29h]
  va_list va; // [rsp+268h] [rbp+10h] BYREF

  va_start(va, Format);
  if ( Format )
  {
    v1 = 0;
    v2 = vsnprintf(Dest, 0x1FFui64, Format, va);
    if ( v2 < 0 || (unsigned __int64)v2 > 0x1FF )
    {
      v4 = 0;
      v1 = -2147483643;
    }
    else if ( v2 == 511i64 )
    {
      v4 = 0;
    }
    DbgPrint("[PTP] %s : ", "Logger");
    if ( v1 >= 0 )
    {
      DbgPrint("'%s'", Dest);
      DbgPrint("\n");
      sub_140003270((__int64)DeviceObject->DeviceExtension, 4u, 0xAu, 0xBu, (__int64)&unk_140009170, Dest);
    }
    else
    {
      DbgPrint("RtlStringCbVPrintfA failed 0x%x", (unsigned int)v1);
      DbgPrint("\n");
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 4u, 0xAu, 0xAu, (__int64)&unk_140009170, v1);
    }
  }
}

//----- (0000000140003270) ----------------------------------------------------
__int64 __fastcall sub_140003270(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, const char *a6)
{
  const char *v6; // rbp
  unsigned __int64 v10; // rsi
  __int64 v11; // rbx
  int v12; // eax
  __int64 v13; // rcx
  const char *v14; // rax
  int v16; // [rsp+20h] [rbp-48h]
  __int64 v17; // [rsp+70h] [rbp+8h]

  v17 = a1;
  v6 = "NULL";
  v10 = (unsigned __int64)a3 >> 16;
  v11 = -1i64;
  v12 = *((_DWORD *)&DeviceObject->Timer + 20 * v10 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v12, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v10 + 1) >= a2 )
  {
    if ( a6 )
    {
      v13 = -1i64;
      do
        ++v13;
      while ( a6[v13] );
    }
    v14 = "NULL";
    if ( a6 )
      v14 = a6;
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v10), 43i64, a5, a4, v14);
    a1 = v17;
  }
  if ( a6 )
  {
    do
      ++v11;
    while ( a6[v11] );
  }
  if ( a6 )
    v6 = a6;
  LOWORD(v16) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v16, v6);
}
// 14000338C: variable 'v16' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (00000001400033B0) ----------------------------------------------------
__int64 __fastcall sub_1400033B0(__int64 a1, unsigned int a2, const void *a3, size_t a4)//ptpfilterCompleteRequestWithData(Request_a1, NTSTATUS_code_a2, sourceBuffer_a3 , size_a4);//&IoControlCode_a3 =sourceBuffer_a3
{
  int v8; // ebx
  int v10; // [rsp+28h] [rbp-20h]
  void *Dst; // [rsp+30h] [rbp-18h] BYREF
  size_t Size[2]; // [rsp+38h] [rbp-10h] BYREF

  v8 = (*(__int64 (__fastcall **)(__int64, __int64, size_t, void **, size_t *))(qword_14000A118 + 2160))(
         qword_14000A110, //v8= WdfRequestRetrieveOutputBuffer(Request, MinimumRequiredLength, PVOID* outBuffer,size_t* Length);
         a1,
         a4,
         &Dst,
         Size);
  if ( v8 >= 0 )
  {
    memset(Dst, 0, Size[0]);
    memmove(Dst, a3, a4);
    (*(void (__fastcall **)(__int64, __int64, _QWORD, size_t))(qword_14000A118 + 2120))(qword_14000A110, a1, a2, a4);
  } //void WdfRequestCompleteWithInformation(Request_a1, NTSTATUS_code_a2, ULONG_PTR Information_size_a4)
  else
  {
    DbgPrint("[PTP] %s : ", "CompleteRequestWithData");
    DbgPrint("CompleteRequestWithData failed with status - 0x%x", (unsigned int)v8);
    DbgPrint("\n");
    v10 = v8;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0xAu, (__int64)&unk_140009180, v10);
  }
  return (unsigned int)v8;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400034B8) ----------------------------------------------------
__int64 __fastcall sub_1400034B8(const void *a1, const void *a2, unsigned int a3, __int64 a4, int a5)
	//void PTPFilterEvtIoDeviceControl(IN WDFQUEUE Queue_a1, IN WDFREQUEST Request_a2,  IN size_t  OutputBufferLength_a3, IN size_t InputBufferLength_a4, IN ULONG IoControlCode_a5 )
{
  int v9; // esi
  __int64 v10; // rax
  __int64 v11; // rax
  unsigned __int8 *v12; // rdi
  int v13; // esi
  int v14; // esi
  int v15; // esi
  int v16; // ebx
  int v17; // eax
  unsigned __int32 v18; // esi
  __int64 v19; // r8
  __int32 v20; // ecx
  unsigned __int8 v21; // al
  __int32 v22; // ebx
  __int64 v24; // [rsp+28h] [rbp-58h]
  __int64 v25; // [rsp+50h] [rbp-30h] BYREF
  __m128i *v26; // [rsp+58h] [rbp-28h] BYREF
  __m128i v27; // [rsp+60h] [rbp-20h]

  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
  v9 = a5;
  DbgPrint(
    "Entry : Queue 0x%p, Request 0x%p OutputBufferLength %d InputBufferLength %d IoControlCode %d",
    a1,
    a2,
    a3,
    a4,
    a5);
  DbgPrint("\n");
  sub_140003F0C((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0xEu, (__int64)&unk_140009180, a1, a2, a3, a4, v9);
  v10 = (*(__int64 (__fastcall **)(__int64, const void *))(qword_14000A118 + 1256))(qword_14000A110, a1);
  v11 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
          qword_14000A110,
          v10,
          off_14000A018);
  v12 = (unsigned __int8 *)v11;
  v13 = v9 - 737216;
  if ( !v13 )
  {
    if ( (*(int (__fastcall **)(__int64, const void *, __int64, __m128i **, __int64 *))(qword_14000A118 + 2152))(
           qword_14000A110,//WdfRequestRetrieveInputBuffer( _In_WDFREQUEST Request_a2,_In_size_t MinimumRequiredLength, _Outptr_result_bytebuffer_(*Length)PVOID* Buffer,_Out_opt_size_t* Length);
           a2,
           a4,
           &v26,
           &v25) >= 0
      && v25 == 20 )
    {
      v20 = v26[1].m128i_i32[0];
      v21 = _mm_cvtsi128_si32(*v26);
      v27 = *v26;
      *v12 = v21;
      if ( v21 )
      {
        *((_QWORD *)v12 + 10) = *(__int64 *)((char *)v27.m128i_i64 + 4);
        *((_DWORD *)v12 + 22) = v27.m128i_i32[3] * v27.m128i_i32[3];//ResetNotificationQueue
        *((_DWORD *)v12 + 23) = v20 * v20;
      }
      DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
      v22 = v27.m128i_i32[0];
      DbgPrint("START_STOP_FILTERING PARAMS, state: %d", v27.m128i_u32[0]);
      DbgPrint("\n");
      LODWORD(v24) = v22;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x10u, (__int64)&unk_140009180, v24);
    }
    LOWORD(a5) = *((_WORD *)v12 + 440);//=pDeviceContext_v12->Physical_Length_X
    HIWORD(a5) = *((_WORD *)v12 + 442);//=pDeviceContext_v12->Physical_Length_Y
    v17 = sub_1400033B0((__int64)a2, 0, &a5, 4ui64);//result = ptpfilterCompleteRequestWithData(Request_a2, STATUS_SUCCESS&IoControlCode_a5 , 4);//&IoControlCode_a5=sourceBuffer_a5
LABEL_19:
    v16 = v17;
    goto LABEL_20;
  }
  v14 = v13 - 4;
  if ( !v14 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    DbgPrint("PTPFilterEvtIoDeviceControl FLUSH %d", 737220i64);
    DbgPrint("\n");
    LODWORD(v24) = 737220;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x11u, (__int64)&unk_140009180, v24);
    v19 = 0i64;
    *((_DWORD *)v12 + 1) = 2;
LABEL_22:
    (*(void (__fastcall **)(__int64, const void *, __int64, _QWORD))(qword_14000A118 + 2120))(
      qword_14000A110,//void WdfRequestCompleteWithInformation(Request_a2, NTSTATUS_code, ULONG_PTR Information_size)
      a2,
      v19,
      0i64);
    goto LABEL_23;
  }
  v15 = v14 - 4;
  if ( v15 )
  {
    if ( v15 != 52 )
    {
      v16 = sub_140003C1C((__int64)a2, v11, 0i64, 8);
      DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
      DbgPrint("OUTPUT3: default - sent request (0x%x)", (unsigned int)v16);
      DbgPrint("\n");
      LODWORD(v24) = v16;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 9u, 0x14u, (__int64)&unk_140009180, v24);
      goto LABEL_20;
    }
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    DbgPrint("OUTPUT3: IOCTL_PTPFILTER_GET_FEATURE_REPORT");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 0, 5u, 0xFu, (__int64)&unk_140009180);
    v17 = (*(__int64 (__fastcall **)(__int64, const void *, _QWORD))(qword_14000A118 + 2248))(
            qword_14000A110,//status_result = WdfRequestForwardToIoQueue(
            a2,
            *((_QWORD *)v12 + 4));//pDeviceContext_v12->ResetNotificationQueue
    goto LABEL_19;
  }
  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
  DbgPrint("OUTPUT3: IOCTL_PTPFILTER_SWITCH_MODE (active:%d)", *v12);
  DbgPrint("\n");
  LODWORD(v24) = *v12;
  sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x12u, (__int64)&unk_140009180, v24);
  v16 = (*(__int64 (__fastcall **)(__int64, const void *, __int64, __m128i **, __int64 *))(qword_14000A118 + 2152))(
          qword_14000A110,//v16 = WdfRequestRetrieveInputBuffer( _In_WDFREQUEST Request_a2,_In_size_t MinimumRequiredLength, _Outptr_result_bytebuffer_(*Length)PVOID* Buffer,_Out_opt_size_t* Length);
          a2,
          a4,
          &v26,
          &v25);
  if ( v16 < 0 )
  {
LABEL_21:
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    DbgPrint("Failed 0x%x", (unsigned int)v16);
    DbgPrint("\n");
    LODWORD(v24) = v16;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0x15u, (__int64)&unk_140009180, v24);
    v19 = (unsigned int)v16;
    goto LABEL_22;
  }
  if ( v25 == 4 ) //Length_v25==4
  {
    v18 = v26->m128i_i32[0];
    if ( *v12 )
    {
      *((_DWORD *)v12 + 146) = v18;
      DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
      DbgPrint("OUTPUT3: IOCTL_PTPFILTER_SWITCH_MODE - %d", v18);
      DbgPrint("\n");
      LODWORD(v24) = v18;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x13u, (__int64)&unk_140009180, v24);
    }
  }
  (*(void (__fastcall **)(__int64, const void *, _QWORD, _QWORD))(qword_14000A118 + 2120))(
    qword_14000A110,//void WdfRequestCompleteWithInformation(Request_a2, NTSTATUS_code, ULONG_PTR Information_size)
    a2,
    (unsigned int)v16,
    0i64);
LABEL_20:
  if ( v16 < 0 )
    goto LABEL_21;
LABEL_23:
  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
  DbgPrint("Exit");
  DbgPrint("\n");
  return sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0x16u, (__int64)&unk_140009180);
}
// 140003628: variable 'v24' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400039F0) ----------------------------------------------------
__int64 __fastcall sub_1400039F0(const void *a1, const void *a2)//PTPFilterEvtIoRead(_In_ WDFQUEUE Queue_a1, _In_ WDFREQUEST Request_a2, _In_size_t Length)
{
  __int64 v4; // rax
  __int64 v5; // rsi
  int v6; // ebx
  unsigned __int16 v7; // r9
  __int64 v9; // [rsp+28h] [rbp-20h]
  char v10; // [rsp+68h] [rbp+20h] BYREF

  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
  DbgPrint("Entry : Queue 0x%p, Request 0x%p", a1, a2);
  DbgPrint("\n");
  sub_140003DF8((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0x17u, (__int64)&unk_140009180, a1, a2);
  v4 = (*(__int64 (__fastcall **)(__int64, const void *))(qword_14000A118 + 1256))(qword_14000A110, a1);//WDFDEVICE Device_v4 = WdfIoQueueGetDevice(Queue_a1);
  v5 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         v4,
         off_14000A018));//pDeviceContext_v5 = GetDeviceContext(Device_v4);
  v10 = 0;//bRequestForwardFlag=FALSE;
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(v5 + 912));//WdfSpinLockAcquire (pDeviceContext_v5->ReadLoopSpinLock_912);
  v6 = sub_1400040A4(v5, (__int64)a2, (__int64)sub_1400053F0);
  //status_v6=PTPFilterCheckAndStartReadLoop(pDeviceContext_v5,Request_a2,Filter_EvtRequestIoctlCompletionRoutine_sub_1400053F0);
  if ( v6 >= 0 )
  {
    v6 = sub_140005608(v5, (__int64)a2, &v10);//status_v6=PTPFilterProcessCurrentRequest(pDeviceContext_v5,Request_a2,&bRequestForwardFlag);
    if ( v6 >= 0 )
      goto LABEL_6;
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("ProcessCurrentRequest failed 0x%x", (unsigned int)v6);
    DbgPrint("\n");
    v7 = 25;
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("CheckAndStartReadLoop failed 0x%x", (unsigned int)v6);
    DbgPrint("\n");
    v7 = 24;
  }
  LODWORD(v9) = v6;
  sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 5u, v7, (__int64)&unk_140009180, v9);
LABEL_6:
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(v5 + 912));//void WdfSpinLockRelease (pDeviceContext_v5->ReadLoopSpinLock_912);
  if ( !v10 )
    (*(void (__fastcall **)(__int64, const void *, _QWORD))(qword_14000A118 + 2104))(//void WdfRequestComplete(Request_a2, status_v6);???
      qword_14000A110,
      a2,
      (unsigned int)v6);
  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
  DbgPrint("Exit");
  DbgPrint("\n");
  return sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0x1Au, (__int64)&unk_140009180);
}
// 140003B79: variable 'v9' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003C1C) ----------------------------------------------------
__int64 __fastcall sub_140003C1C(__int64 a1, __int64 a2, __int64 a3, int a4)
{
  unsigned int v8; // ebx
  int *v9; // rdi
  int v11; // [rsp+28h] [rbp-50h]
  int v12[2]; // [rsp+30h] [rbp-48h] BYREF
  __int64 v13; // [rsp+38h] [rbp-40h]

  DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0xBu, (__int64)&unk_140009180);
  v8 = 0;
  v9 = 0i64;
  if ( a4 )
  {
    v13 = 0i64;
    v9 = v12;
    v12[0] = 16;
    v12[1] = a4;
  }
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 2008))(qword_14000A110, a1);
  (*(void (__fastcall **)(__int64, __int64, __int64, __int64))(qword_14000A118 + 2080))(qword_14000A110, a1, a3, a2);
  if ( !(*(unsigned __int8 (__fastcall **)(__int64, __int64, _QWORD, int *))(qword_14000A118 + 2024))(
          qword_14000A110,
          a1,
          *(_QWORD *)(a2 + 16),
          v9) )
  {
    v8 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2032))(qword_14000A110, a1);
    DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
    DbgPrint("WdfRequestSend failed 0x%x", v8);
    DbgPrint("\n");
    v11 = v8;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0xCu, (__int64)&unk_140009180, v11);
  }
  DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 5u, 0xDu, (__int64)&unk_140009180);
  return v8;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003DF8) ----------------------------------------------------
__int64 sub_140003DF8(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-48h]
  va_list va; // [rsp+98h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140003EEC: variable 'v12' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140003F0C) ----------------------------------------------------
__int64 sub_140003F0C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-78h]
  va_list va; // [rsp+C8h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 14000407C: variable 'v12' is possibly undefined
// 1400061B7: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (00000001400040A4) ----------------------------------------------------
__int64 __fastcall sub_1400040A4(__int64 a1, __int64 a2, __int64 a3)//NTSTATUS PTPFilterCheckAndStartReadLoop(pDeviceContext_a1,Request_a2CompletionRoutine_a3);
{
  int v6; // edi
  int v8; // [rsp+28h] [rbp-10h]

  DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 6u, 0xFu, (__int64)&unk_140009190);
  v6 = 0;
  if ( !*(_BYTE *)(a1 + 908) && !*(_BYTE *)(a1 + 920) )//!pDeviceContext_a1->RequestDataAvailableFlag && !pDeviceContext_a1->RequestLength;
  {
    *(_BYTE *)(a1 + 908) = 1;//pDeviceContext_a1->RequestDataAvailableFlag=TRUE;//TRUE
    DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
    DbgPrint("Read Loop Started");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 6u, 0x10u, (__int64)&unk_140009190);
    
    *(_QWORD *)(a1 + 24) = *(_QWORD *)(*(_QWORD *)((*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2280))(
                                                     qword_14000A110,
                                                     a2)
                                                 + 184)
                                     + 48i64);
    //pDeviceContext->ReportBuffer = (PCHAR)((PHID_XFER_PACKET)(WdfRequestWdmGetIrp(Request_a2)->UserBuffer))->reportBuffer;
    
    v6 = sub_14000428C((_QWORD *)a1, a3);//status_v6=PTPFilterSendReadRequest(pDeviceContext_a1, CompletionRoutine_a3);
    if ( v6 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
      DbgPrint("PTPFilterSendReadRequest failed 0x%x", (unsigned int)v6);
      DbgPrint("\n");
      v8 = v6;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 6u, 0x11u, (__int64)&unk_140009190, v8);
      *(_BYTE *)(a1 + 908) = 0;//pDeviceContext->RequestDataAvailableFlag = FALSE;
    }
  }
  DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 6u, 0x12u, (__int64)&unk_140009190);
  return (unsigned int)v6;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000428C) ----------------------------------------------------
__int64 __fastcall sub_14000428C(_QWORD *a1, __int64 a2)//PTPFilterSendReadRequest(pDeviceContext_a1, CompletionRoutine_a2);
{
  __int64 v4; // rdx
  int v5; // ebx
  unsigned __int16 v6; // r9
  __int64 v8; // [rsp+28h] [rbp-50h]
  __int64 v9; // [rsp+30h] [rbp-48h] BYREF
  int v10; // [rsp+38h] [rbp-40h]
  __int64 v11; // [rsp+3Ch] [rbp-3Ch]
  int v12; // [rsp+44h] [rbp-34h]

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("Entry");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 6u, 0xAu, (__int64)&unk_140009190);
  }
  v4 = a1[96];
  //request_v4=pDeviceContext_a1->Request,
  // 3WDF_REQUEST_REUSE_PARAMS reuseParams;    WDF_REQUEST_REUSE_PARAMS_INIT(&reuseParams,WDF_REQUEST_REUSE_NO_FLAGS, STATUS_SUCCESS) 
  
  v11 = 0i64;
  v12 = 0;
  v9 = 24i64;
  v10 = 0;
  v5 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 1992))(qword_14000A110, v4, &v9);
    //status_v5 =WdfRequestReuse(Request_v4, &reuseParams_v11);
  if ( v5 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfRequestReuse failed 0x%x", (unsigned int)v5);
    DbgPrint("\n");
    v6 = 11;
LABEL_5:
    LODWORD(v8) = v5;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 6u, v6, (__int64)&unk_140009190, v8);
    goto LABEL_10;
  }
  v5 = (*(__int64 (__fastcall **)(__int64, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))(qword_14000A118 + 1464))(
         qword_14000A110,//status_v7=WdfIoTargetFormatRequestForRead(
         a1[2],//pDeviceContext_a1->ioTarget,
         a1[96],//pDeviceContext_a1->Request,
         a1[97],//pDeviceContext_a1->OutputBuffer
         0i64,//OutputBufferOffset=0
         0i64);//DeviceOffset=0
  if ( v5 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfIoTargetFormatRequestForRead failed 0x%x", (unsigned int)v5);
    DbgPrint("\n");
    v6 = 12;
    goto LABEL_5;
  }
  (*(void (__fastcall **)(__int64, _QWORD, __int64, _QWORD *))(qword_14000A118 + 2080))(qword_14000A110, a1[96], a2, a1);
  //void WdfRequestSetCompletionRoutine(Request_a1, AmtPtpRequestCompletionRoutine_a2 ,pDeviceContext_a1);
  
  *(_QWORD *)(*(_QWORD *)((*(__int64 (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2280))(qword_14000A110, a1[96])
                        + 184)// (PCHAR)(PHID_XFER_PACKET)(WdfRequestWdmGetIrp(Request_a2)->UserBuffer)
            - 24i64) = a1[3];////=PLIST_ENTRY_a1[3];//
  if ( !(*(unsigned __int8 (__fastcall **)(__int64, _QWORD, _QWORD, _QWORD))(qword_14000A118 + 2024))(
          qword_14000A110,//ret = WdfRequestSend(pDeviceContext_a1->Request, pDeviceContext_a1->ioTarget, &options);
          a1[96],
          a1[2],
          0i64) )
  {
    v5 = (*(__int64 (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2032))(qword_14000A110, a1[96]);//status_v5 = WdfRequestGetStatus(pDeviceContext_a1->Request);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfRequestSend failed 0x%x", (unsigned int)v5);
    DbgPrint("\n");
    v6 = 13;
    goto LABEL_5;
  }
LABEL_10:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("Exit");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 5u, 6u, 0xEu, (__int64)&unk_140009190);
  }
  return (unsigned int)v5;
}
// 14000439D: variable 'v8' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004538) ----------------------------------------------------
__int64 __fastcall sub_140004538(__int64 a1)
{
  USHORT *v1; // r9
  unsigned int v3; // edi
  __int64 result; // rax
  _WORD *v5; // rdx
  __int64 v6; // r8
  __int64 v7; // [rsp+28h] [rbp-20h]
  ULONG v8; // [rsp+50h] [rbp+8h] BYREF

  v1 = *(USHORT **)(a1 + 872);
  v8 = *(unsigned __int16 *)(a1 + 854);
  v3 = HidP_GetUsages(
         HidP_Input,
         9u,
         0,
         v1,
         &v8,
         *(PHIDP_PREPARSED_DATA *)(a1 + 800),
         *(PCHAR *)(a1 + 784),
         *(_DWORD *)(a1 + 792));
  *(_WORD *)(a1 + 760) = 0;
  *(_BYTE *)(a1 + 762) = 0;
  if ( v3 == 1114112 )
  {
    result = v8;
    if ( v8 )
    {
      v5 = *(_WORD **)(a1 + 872);
      v6 = v8;
      do
      {
        switch ( *v5 )
        {
          case 1:
            *(_BYTE *)(a1 + 760) = 1;
            break;
          case 2:
            *(_BYTE *)(a1 + 761) = 1;
            break;
          case 3:
            *(_BYTE *)(a1 + 762) = 1;
            break;
        }
        ++v5;
        --v6;
      }
      while ( v6 );
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "DetectHardwareButtonStates");
    DbgPrint("output6: Error getting button usage, 0x%x", v3);
    DbgPrint("\n");
    LODWORD(v7) = v3;
    result = sub_1400019C0((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x24u, (__int64)&unk_1400091A0, v7);
  }
  return result;
}
// 140004648: variable 'v7' is possibly undefined

//----- (0000000140004658) ----------------------------------------------------
__int64 __fastcall sub_140004658(__int64 a1, int a2)
{
  __int64 v3; // rdx
  int v5; // edi
  LONGLONG v6; // rax
  __int64 v7; // rdx
  int v9; // [rsp+28h] [rbp-8h]
  int v10; // [rsp+28h] [rbp-8h]
  int v11; // [rsp+28h] [rbp-8h]
  size_t Size; // [rsp+50h] [rbp+20h] BYREF
  __int64 v13; // [rsp+60h] [rbp+30h] BYREF
  void *Dst; // [rsp+68h] [rbp+38h] BYREF

  Dst = 0i64;
  v3 = *(_QWORD *)(a1 + 32);
  Size = 0i64;
  v5 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 1264))(qword_14000A110, v3, &v13);
  if ( v5 >= 0 )
  {
    v6 = sub_140001AF4();
    v7 = v13;
    *(_QWORD *)(a1 + 40) = v6;
    v5 = (*(__int64 (__fastcall **)(__int64, __int64, __int64, void **, size_t *))(qword_14000A118 + 2160))(
           qword_14000A110,
           v7,
           1i64,
           &Dst,
           &Size);
    DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
    if ( v5 >= 0 )
    {
      DbgPrint("WdfRequestRetrieveOutputBuffer got control buffer with length: %d", (unsigned int)Size);
      DbgPrint("\n");
      v11 = Size;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0xDu, (__int64)&unk_1400091A0, v11);
      if ( Size < 4 )
      {
        DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
        DbgPrint("Buffer length is smaller than data");
        DbgPrint("\n");
        sub_14000129C((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xEu, (__int64)&unk_1400091A0);
        (*(void (__fastcall **)(__int64, __int64, __int64, __int64))(qword_14000A118 + 2120))(
          qword_14000A110,
          v13,
          3221225990i64,
          4i64);
        return 3221225990i64;
      }
      memset(Dst, 0, Size);
      *(_DWORD *)Dst = a2;
      (*(void (__fastcall **)(__int64, __int64, _QWORD, __int64))(qword_14000A118 + 2120))(
        qword_14000A110,
        v13,
        0i64,
        4i64);
    }
    else
    {
      DbgPrint("WdfRequestRetrieveOutputBuffer failed with status - 0x%x", (unsigned int)v5);
      DbgPrint("\n");
      v10 = v5;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xCu, (__int64)&unk_1400091A0, v10);
      (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2104))(
        qword_14000A110,
        v13,
        (unsigned int)v5);
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
    DbgPrint("WdfIoQueueRetrieveNextRequest failed with status - 0x%x", (unsigned int)v5);
    DbgPrint("\n");
    v9 = v5;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xBu, (__int64)&unk_1400091A0, v9);
  }
  return (unsigned int)v5;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400048B8) ----------------------------------------------------
__int64 __fastcall sub_1400048B8(__int64 a1, const void *a2, size_t a3)
{
  int v6; // edi
  int v8; // [rsp+28h] [rbp-20h]
  void *Dst; // [rsp+30h] [rbp-18h] BYREF
  size_t Size; // [rsp+68h] [rbp+20h] BYREF

  v6 = (*(__int64 (__fastcall **)(__int64, __int64, size_t, void **, size_t *))(qword_14000A118 + 2160))(
         qword_14000A110,
         a1,
         a3,
         &Dst,
         &Size);
  if ( v6 >= 0 )
  {
    memset(Dst, 0, Size);
    if ( Size >= a3 )
      memmove(Dst, a2, a3);
    (*(void (__fastcall **)(__int64, __int64, _QWORD, size_t))(qword_14000A118 + 2120))(qword_14000A110, a1, 0i64, a3);
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterCompleteReadRequest");
    DbgPrint("WdfRequestRetrieveOutputBuffer failed with status - 0x%x", (unsigned int)v6);
    DbgPrint("\n");
    v8 = v6;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xAu, (__int64)&unk_1400091A0, v8);
  }
  return (unsigned int)v6;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400049B8) ----------------------------------------------------
__int64 __fastcall sub_1400049B8(__int64 a1)
{
  unsigned int v2; // ebx
  int v3; // edi
  __int64 v5; // [rsp+28h] [rbp-20h]

  DbgPrint("[PTP] %s : ", "PTPFilterFlushPendingRequests");
  DbgPrint("PTPFilterFlushPendingRequests");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x12u, (__int64)&unk_1400091A0);
  v2 = 0;
  v3 = 0;
  do
  {
    if ( *(_QWORD *)(a1 + 944) == a1 + 944 )
      break;
    v3 = sub_140005A3C(a1);
    if ( v3 >= 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterFlushPendingRequests");
      DbgPrint("FLUSH - run PTPFilterProcessPendingRequest for report - 0x%x", (unsigned int)v3);
      DbgPrint("\n");
      LODWORD(v5) = v3;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 0, 8u, 0x13u, (__int64)&unk_1400091A0, v5);
    }
  }
  while ( v3 >= 0 );
  if ( v3 != -2147483622 )
    v2 = v3;
  return v2;
}
// 140004A97: variable 'v5' is possibly undefined

//----- (0000000140004AC8) ----------------------------------------------------
__int64 __fastcall sub_140004AC8(__int64 a1)
{
  __int64 result; // rax

  result = sub_1400064BC(a1 + 64);
  *(_DWORD *)(a1 + 900) = 0;
  *(_DWORD *)(a1 + 904) = 0;
  return result;
}

//----- (0000000140004AF8) ----------------------------------------------------
__int64 __fastcall sub_140004AF8(__int64 a1, int a2)
{
  unsigned int v2; // esi
  unsigned int v5; // eax

  v2 = 0;
  if ( *(_DWORD *)(a1 + 580) == 16 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
    DbgPrint("PTPFilterProcessInputFrame canceled");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Du, (__int64)&unk_1400091A0);
    v5 = sub_1400049B8(a1);
    *(_DWORD *)(a1 + 4) = 0;
    v2 = v5;
  }
  if ( a2 == 8 || a2 == 1 )
  {
    if ( *(_DWORD *)(a1 + 572) == 2 && sub_140001AF4() - *(_QWORD *)(a1 + 560) > (unsigned __int64)*(int *)(a1 + 84) )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
      DbgPrint("PTPFilterProcessInputFrame fingers up - DELETE ALL");
      DbgPrint("\n");
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Eu, (__int64)&unk_1400091A0);
      sub_14000124C((__int64 **)(a1 + 944));
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
      DbgPrint("PTPFilterProcessInputFrame fingers up - FLUSH");
      DbgPrint("\n");
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Fu, (__int64)&unk_1400091A0);
      v2 = sub_1400049B8(a1);
    }
    *(_DWORD *)(a1 + 4) = 0;
  }
  return v2;
}

//----- (0000000140004C74) ----------------------------------------------------
__int64 __fastcall sub_140004C74(__int64 a1)
{
  __int64 v1; // rdx
  int v3; // edi
  int v4; // edi
  unsigned __int16 v5; // r9
  __int64 v7; // [rsp+28h] [rbp-20h]
  int v8; // [rsp+28h] [rbp-20h]
  int v9; // [rsp+28h] [rbp-20h]
  unsigned __int8 v10; // [rsp+50h] [rbp+8h] BYREF
  char v11; // [rsp+58h] [rbp+10h] BYREF
  int v12; // [rsp+60h] [rbp+18h] BYREF

  v1 = *(_QWORD *)(a1 + 960);
  v12 = 0;
  v11 = 0;
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 2528))(qword_14000A110, v1);
  sub_140004538(a1);
  v3 = sub_140002040(a1, (unsigned int *)&v12, &v11);
  if ( v3 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
    DbgPrint("PTPFilterGetFingersCount failed with status - 0x%x", (unsigned int)v3);
    DbgPrint("\n");
    v8 = v3;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x25u, (__int64)&unk_1400091A0, v8);
    v4 = sub_1400010B4(a1 + 944, *(_WORD *)(a1 + 812), *(const void **)(a1 + 784), *(_DWORD *)(a1 + 792), v12);
    if ( v4 >= 0 )
    {
      sub_140001058((__int64 **)(a1 + 928), a1 + 944, &v10);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint(
        "PTPFilterHandleDeviceData - No fingers in report. PTPFilterBufferProcessData, rawDataProcessed: %d",
        v10);
      DbgPrint("\n");
      LODWORD(v7) = v10;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x27u, (__int64)&unk_1400091A0, v7);
      v4 = sub_140005A3C(a1);
      if ( v4 >= 0 )
        goto LABEL_12;
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint("PTPFilterProcessPendingRequest failed with status - 0x%x", (unsigned int)v4);
      DbgPrint("\n");
      v5 = 40;
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint("PTPFilterBufferStoreReport failed with status - 0x%x", (unsigned int)v4);
      DbgPrint("\n");
      v5 = 38;
    }
    goto LABEL_4;
  }
  v4 = sub_1400010B4(a1 + 928, *(_WORD *)(a1 + 812), *(const void **)(a1 + 784), *(_DWORD *)(a1 + 792), v12);
  if ( v4 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
    DbgPrint("PTPFilterBufferStoreReport failed with status - 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    v5 = 41;
LABEL_4:
    LODWORD(v7) = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, v5, (__int64)&unk_1400091A0, v7);
    goto LABEL_12;
  }
  if ( v11 )
  {
    v4 = sub_140005798((unsigned __int8 *)a1);
    if ( v4 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint("PTPFilterProcessInputFrame failed with status - 0x%x", (unsigned int)v4);
      DbgPrint("\n");
      v9 = v4;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x2Au, (__int64)&unk_1400091A0, v9);
      *(_DWORD *)(a1 + 900) = 0;
      *(_DWORD *)(a1 + 904) = 0;
    }
  }
LABEL_12:
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));
  return (unsigned int)v4;
}
// 140004DA7: variable 'v7' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004F80) ----------------------------------------------------
void __fastcall sub_140004F80(__int64 a1, unsigned int a2, _BYTE *a3)
{
  __int64 v6; // [rsp+30h] [rbp+8h] BYREF

  if ( *(_BYTE *)(a1 + 920) )
  {
    *(_BYTE *)(a1 + 908) = 0;
    *a3 = 0;
  }
  else
  {
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(a1 + 912));
    if ( (*(int (__fastcall **)(__int64, _QWORD, __int64 *))(qword_14000A118 + 1264))(
           qword_14000A110,
           *(_QWORD *)(a1 + 56),
           &v6) >= 0 )
    {
      *a3 = 1;
      (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 912));
      (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2104))(qword_14000A110, v6, a2);
    }
    else
    {
      *(_BYTE *)(a1 + 908) = 0;
      *a3 = 0;
      (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 912));
    }
  }
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005060) ----------------------------------------------------
bool __fastcall sub_140005060(__int64 a1, unsigned int a2)
{
  bool v5; // zf
  int v6; // eax
  const char *v7; // rbx

  sub_140006340(a1 + 64, a2);
  switch ( a2 )
  {
    case 2u:
      *(_DWORD *)(a1 + 4) = *(_BYTE *)(a1 + 552) == 0;
      DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
      DbgPrint("PTPFilterProcessInputFrame One finger down, waiting for gesture");
      DbgPrint("\n");
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x18u, (__int64)&unk_1400091A0);
      return 1;
    case 4u:
      sub_1400049B8(a1);
LABEL_6:
      *(_DWORD *)(a1 + 4) = 0;
      return 1;
    case 5u:
      if ( *(_DWORD *)(a1 + 4) == 1 )
      {
        sub_14000124C((__int64 **)(a1 + 944));
        DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
        DbgPrint("PTPFilterProcessInputFrame TwoFingerStart, all one-finger reports are removed!");
        DbgPrint("\n");
        sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x19u, (__int64)&unk_1400091A0);
      }
      *(_DWORD *)(a1 + 4) = 1;
      return 1;
  }
  if ( a2 - 6 <= 1 )
    return 1;
  if ( a2 == 9 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
    DbgPrint("PTPFilterProcessInputFrame GestureType_ThreeFingerStart, all prior reports are removed!");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Au, (__int64)&unk_1400091A0);
    sub_14000124C((__int64 **)(a1 + 944));
    goto LABEL_6;
  }
  if ( a2 == 10 )
  {
    if ( *(_DWORD *)(a1 + 584) == 1 )
      sub_1400024AC(a1, (__int64 **)(a1 + 928));
    v5 = *(_DWORD *)(a1 + 572) == 10;
    return !v5;
  }
  if ( a2 - 11 <= 1 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
    v7 = "Vertical";
    if ( a2 == 11 )
      v7 = "Horizontal";
    DbgPrint("PTPFilterProcessInputFrame GestureType_InternalThreeFingerMove, %s", v7);
    DbgPrint("\n");
    sub_140003270((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Bu, (__int64)&unk_1400091A0, v7);
    if ( *(_DWORD *)(a1 + 584) == 1 )
      sub_1400024AC(a1, (__int64 **)(a1 + 928));
    v5 = *(_DWORD *)(a1 + 572) == a2;
    return !v5;
  }
  if ( a2 <= 0xD )
  {
    v6 = 8450;
    if ( _bittest(&v6, a2) )
    {
      if ( *(_DWORD *)(a1 + 584) == 1 )
      {
        sub_14000124C((__int64 **)(a1 + 944));
        DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
        DbgPrint("PTPFilterProcessInputFrame potentialGesture %d, previousGesture %d", a2, *(unsigned int *)(a1 + 572));
        DbgPrint("\n");
        sub_140003020(
          (__int64)DeviceObject->DeviceExtension,
          4u,
          8u,
          0x1Cu,
          (__int64)&unk_1400091A0,
          a2,
          *(_DWORD *)(a1 + 572));
      }
      return 1;
    }
  }
  return 0;
}

//----- (0000000140005360) ----------------------------------------------------
__int64 __fastcall sub_140005360(__int64 a1, _BYTE *a2)
{
  int v3; // ebx
  int v5; // [rsp+28h] [rbp-10h]

  sub_140001058((__int64 **)(a1 + 928), a1 + 944, a2);
  v3 = sub_140005A3C(a1);
  if ( v3 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterMoveReportsForward");
    DbgPrint("PTPFilterProcessPendingRequest failed with status - 0x%x", (unsigned int)v3);
    DbgPrint("\n");
    v5 = v3;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x17u, (__int64)&unk_1400091A0, v5);
  }
  return (unsigned int)v3;
}

//----- (00000001400053F0) ----------------------------------------------------
__int64 __fastcall sub_1400053F0(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
  char v6; // si
  signed int v7; // ebx
  int v8; // ebx
  int v9; // ebx
  __int64 v11; // [rsp+28h] [rbp-30h]
  signed int v12; // [rsp+28h] [rbp-30h]
  int v13; // [rsp+28h] [rbp-30h]
  char v14; // [rsp+78h] [rbp+20h] BYREF

  DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x2Bu, (__int64)&unk_1400091A0);
  v6 = 1;
  v14 = 1;
  v7 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2032))(qword_14000A110, a1);
  if ( v7 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("Read request failed with status - 0x%x", (unsigned int)v7);
    DbgPrint("\n");
    v12 = v7;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Cu, (__int64)&unk_1400091A0, v12);
    sub_140004F80(a4, v7, &v14);
    v6 = v14;
    goto LABEL_5;
  }
  v8 = sub_140004C74(a4);
  if ( v8 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("HandleDeviceData failed with status - 0x%x", (unsigned int)v8);
    DbgPrint("\n");
    v13 = v8;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Du, (__int64)&unk_1400091A0, v13);
LABEL_5:
    if ( !v6 )
      goto LABEL_8;
  }
  v9 = sub_14000428C((_QWORD *)a4, (__int64)sub_1400053F0);
  if ( v9 < 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("SendReadRequest failed unexpectedly 0x%x", (unsigned int)v9);
    DbgPrint("\n");
    LODWORD(v11) = v9;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Eu, (__int64)&unk_1400091A0, v11);
    *(_BYTE *)(a4 + 908) = 0;
  }
LABEL_8:
  DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
  DbgPrint("Exit");
  DbgPrint("\n");
  return sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x2Fu, (__int64)&unk_1400091A0);
}
// 14000559D: variable 'v11' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005608) ----------------------------------------------------
__int64 __fastcall sub_140005608(__int64 a1, __int64 a2, _BYTE *a3)
{
  int v5; // edi
  __int64 **v7; // rcx
  __int64 *v8; // rbx
  unsigned __int16 v9; // r9
  int v11; // [rsp+28h] [rbp-10h]

  v5 = 0;
  *a3 = 0;
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(a1 + 960));
  v7 = (__int64 **)(a1 + 944);
  if ( *v7 != (__int64 *)v7 )
  {
    v8 = sub_140001278(v7);
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));
    v5 = sub_1400048B8(a2, (const void *)v8[3], *(unsigned int *)(a1 + 792));
    sub_140001000(v8);
    if ( v5 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterProcessCurrentRequest");
      DbgPrint("WdfRequestForwardToIoQueue failed 0x%x", (unsigned int)v5);
      DbgPrint("\n");
      v9 = 15;
LABEL_7:
      v11 = v5;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, v9, (__int64)&unk_1400091A0, v11);
      return (unsigned int)v5;
    }
    goto LABEL_8;
  }
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));
  if ( !*a3 )
  {
    v5 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2248))(
           qword_14000A110,
           a2,
           *(_QWORD *)(a1 + 56));
    if ( v5 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterProcessCurrentRequest");
      DbgPrint("WdfRequestForwardToIoQueue failed 0x%x", (unsigned int)v5);
      DbgPrint("\n");
      v9 = 16;
      goto LABEL_7;
    }
LABEL_8:
    *a3 = 1;
  }
  return (unsigned int)v5;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005798) ----------------------------------------------------
__int64 __fastcall sub_140005798(unsigned __int8 *a1)
{
  bool v2; // si
  unsigned int v3; // ebx
  unsigned int v4; // eax
  __int64 v6; // [rsp+28h] [rbp-8h]
  char v7; // [rsp+60h] [rbp+30h] BYREF
  unsigned int v8; // [rsp+68h] [rbp+38h] BYREF

  v8 = 0;
  v2 = 0;
  v7 = 0;
  DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
  DbgPrint("Entry (active:%d)", *a1);
  DbgPrint("\n");
  sub_1400019C0((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x20u, (__int64)&unk_1400091A0, *a1);
  v3 = sub_140001CFC((__int64)a1);
  if ( (v3 & 0x80000000) != 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
    DbgPrint("PTPFilterCreateContactsFromHidReport failed with status - 0x%x", v3);
    DbgPrint("\n");
    LODWORD(v6) = v3;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x21u, (__int64)&unk_1400091A0, v6);
    v4 = sub_140005360((__int64)a1, &v7);
    goto LABEL_3;
  }
  if ( *a1 )
  {
    sub_1400062B4((_DWORD *)a1 + 16, (__int64 *)a1 + 74, a1 + 760, (void (*)(const char *, ...))sub_140003134);
    sub_14000643C((unsigned int *)a1 + 16, &v8, (void (*)(const char *, ...))sub_140003134);
    if ( v8 )
    {
      v2 = sub_140005060((__int64)a1, v8);
      sub_1400064BC((__int64)(a1 + 64));
    }
    if ( *((_DWORD *)a1 + 1) == 1 )
    {
      sub_140001058((__int64 **)a1 + 116, (__int64)(a1 + 944), &v7);
      sub_140004AF8((__int64)a1, v8);
      if ( !v2 )
        goto LABEL_4;
      v4 = sub_140005B14((__int64)a1, v8);
LABEL_3:
      v3 = v4;
LABEL_4:
      sub_140004AC8((__int64)a1);
      return v3;
    }
  }
  if ( *((_DWORD *)a1 + 1) == 2 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
    DbgPrint("PTPFilterProcessInputFrame got FLUSH");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x22u, (__int64)&unk_1400091A0);
    sub_14000124C((__int64 **)a1 + 118);
    sub_1400049B8((__int64)a1);
    *((_DWORD *)a1 + 1) = 0;
  }
  v3 = sub_140005360((__int64)a1, &v7);
  if ( !v7 )
    v3 = sub_140005360((__int64)a1, &v7);
  if ( v2 )
    v3 = sub_140005B14((__int64)a1, v8);
  sub_140004AC8((__int64)a1);
  DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x23u, (__int64)&unk_1400091A0);
  return v3;
}
// 140005871: variable 'v6' is possibly undefined

//----- (0000000140005A3C) ----------------------------------------------------
__int64 __fastcall sub_140005A3C(__int64 a1)
{
  int v2; // edi
  __int64 *v3; // rbx
  int v5; // [rsp+28h] [rbp-10h]
  __int64 v6; // [rsp+40h] [rbp+8h] BYREF

  v2 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64 *))(qword_14000A118 + 1264))(
         qword_14000A110,
         *(_QWORD *)(a1 + 56),
         &v6);
  if ( v2 >= 0 )
  {
    v3 = sub_140001278((__int64 **)(a1 + 944));
    v2 = sub_1400048B8(v6, (const void *)v3[3], *(unsigned int *)(a1 + 792));
    sub_140001000(v3);
    if ( v2 < 0 )
    {
      DbgPrint("[PTP] %s : ", "PTPFilterProcessPendingRequest");
      DbgPrint("PTPFilterCompleteReadRequest failed with status - 0x%x", (unsigned int)v2);
      DbgPrint("\n");
      v5 = v2;
      sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x11u, (__int64)&unk_1400091A0, v5);
    }
  }
  return (unsigned int)v2;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005B14) ----------------------------------------------------
__int64 __fastcall sub_140005B14(__int64 a1, unsigned int a2)
{
  int v3; // eax
  unsigned int v4; // ebx
  unsigned __int16 v5; // r9
  unsigned __int8 v6; // dl
  int v7; // eax
  unsigned int v9; // [rsp+28h] [rbp-10h]
  int v10; // [rsp+50h] [rbp+18h] BYREF

  v3 = sub_140006368(a2, (unsigned int *)&v10);
  v4 = (unsigned __int16)v3 | 0xC0070000;
  if ( v3 <= 0 )
    v4 = v3;
  if ( (v4 & 0x80000000) != 0 )
  {
    DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
    DbgPrint("RecognizerGetGestureData failed with status - 0x%x", v4);
    DbgPrint("\n");
    v5 = 20;
    v6 = 2;
LABEL_10:
    v9 = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, v6, 8u, v5, (__int64)&unk_1400091A0, v9);
    return v4;
  }
  v7 = sub_140004658(a1, v10);
  v4 = v7;
  if ( v7 < 0 )
  {
    if ( v7 != -2147483622 )
    {
      *(_DWORD *)(a1 + 4) = 2;
      *(_BYTE *)a1 = 0;
      DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
      DbgPrint("PTPFilterCompleteControlRequest failed with status - 0x%x", v4);
      DbgPrint("\n");
      v5 = 22;
      v6 = 3;
      goto LABEL_10;
    }
    if ( *(_QWORD *)(a1 + 40) + 30i64 < (unsigned __int64)sub_140001AF4() )
    {
      *(_DWORD *)(a1 + 4) = 2;
      *(_BYTE *)a1 = 0;
      DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
      DbgPrint("CompleteControlRequest queue was empty for 30ms, stopping filter");
      DbgPrint("\n");
      sub_14000129C((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x15u, (__int64)&unk_1400091A0);
    }
  }
  return v4;
}

//----- (0000000140005C88) ----------------------------------------------------
__int64 __fastcall sub_140005C88(char a1, char a2, int a3, int a4)
{
  char v4; // cl
  unsigned int v6; // edi
  unsigned int v8; // er10
  _BYTE *v9; // rax
  char v10; // r11
  unsigned int v11; // edx
  int v12; // edx
  int v13; // esi
  int v14; // ebp
  __int16 v15; // bx
  unsigned int v16; // eax
  int v17; // er14

  v4 = a1 & 0xF;
  v6 = 0;
  v8 = 0;
  v9 = word_1400091B0;
  v10 = 1;
  do
  {
    if ( *v9 == v4 )
      break;
    ++v8;
    v9 += 4;
  }
  while ( v8 < 0xB );
  v11 = a2 & 0xF;
  if ( v11 >= 5 )
    return v6;
  v12 = dword_1400091E0[v11] - 1;
  if ( !v12 )
    goto LABEL_8;
  if ( v12 != 2 )
  {
    v10 = 0;
LABEL_8:
    v13 = 1000;
    v14 = 1000;
    if ( !v10 )
      return v6;
    goto LABEL_9;
  }
  v13 = 2540;
  v14 = 2540;
LABEL_9:
  if ( v8 < 0xB )
  {
    v15 = word_1400091B0[2 * v8 + 1];
    v16 = sub_140005D5C(v15);
    v17 = a3 - a4;
    if ( v15 >= 0 )
    {
      v6 = v16 * v17 * v14;
    }
    else if ( v16 )
    {
      v6 = v17 * v13 / v16;
    }
  }
  return v6;
}

//----- (0000000140005D5C) ----------------------------------------------------
__int64 __fastcall sub_140005D5C(__int16 a1)
{
  int v1; // edx
  __int64 result; // rax
  bool v3; // zf

  v1 = 10;
  result = 1i64;
  v3 = a1 == 0;
  if ( a1 < 0 )
  {
    a1 = -a1;
    v3 = a1 == 0;
  }
  if ( !v3 )
  {
    do
    {
      if ( (a1 & 1) != 0 )
        result = (unsigned int)(v1 * result);
      v1 *= v1;
      a1 >>= 1;
    }
    while ( a1 );
  }
  return result;
}

//----- (0000000140005E20) ----------------------------------------------------
__int64 __fastcall sub_140005E20(__int64 a1, __int64 a2)
{
  __int64 result; // rax
  unsigned __int8 v3; // dl

  result = *(_QWORD *)(a2 + 8);
  v3 = *(_BYTE *)(*(unsigned int *)(*(_QWORD *)(a2 + 16) + 8i64) + result + 3);
  if ( (v3 & 0xF) != 0 )
    result = v3 & 0xF0;
  return result;
}

//----- (0000000140005E88) ----------------------------------------------------
__int64 sub_140005E88()
{
  sub_140006140((__int64)&unk_14000A040);
  return WdfVersionUnbind(&DestinationString, &unk_14000A040, qword_14000A110);
}
// 140006CD6: using guessed type __int64 __fastcall WdfVersionUnbind(_QWORD, _QWORD, _QWORD);
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (0000000140005EE4) ----------------------------------------------------
NTSTATUS __stdcall DriverEntry(_DRIVER_OBJECT *DriverObject, PUNICODE_STRING RegistryPath)
{
  NTSTATUS result; // eax
  NTSTATUS v5; // ebx
  __int64 (*v6)(void); // rax

  if ( !DriverObject )
    return sub_14000D000(0i64, (__int64)RegistryPath);//return FxDriverEntryWorker(DriverObject_NULL, RegistryPath)
  qword_14000A120 = (__int64)DriverObject;
  DestinationString.Buffer = (PWSTR)&unk_14000A130;
  *(_DWORD *)&DestinationString.Length = 34078720;
  RtlCopyUnicodeString(&DestinationString, RegistryPath);
  result = WdfVersionBind(DriverObject, &DestinationString, &unk_14000A040, &qword_14000A110);
  if ( result >= 0 )
  {
    qword_14000A128 = *(_QWORD *)(qword_14000A118 + 1608);
    v5 = sub_1400060A8((__int64)&unk_14000A040);//status_v5 = FxStubBindClasses(&WdfBindInfo_unk_14000A040);
    if ( v5 < 0
      || (v5 = sub_14000603C(), v5 < 0)//(status_v5=FxStubInitTypes(),status_v5<0)
      || (v5 = sub_14000D000((__int64)DriverObject, (__int64)RegistryPath), v5 < 0) )//(v5 = FxDriverEntryWorker(DriverObject, RegistryPath), v5 < 0) )
    {
      sub_140005E88();
      result = v5;
    }
    else
    {
      if ( *(_BYTE *)(qword_14000A110 + 48) )
      {
        v6 = qword_14000A108;
        if ( DriverObject->DriverUnload )
          v6 = (__int64 (*)(void))DriverObject->DriverUnload;
        qword_14000A108 = v6;
        DriverObject->DriverUnload = (PDRIVER_UNLOAD)sub_140006014;
      }
      else if ( (*(_DWORD *)(qword_14000A110 + 8) & 2) != 0 )
      {
        qword_14000A128 = (__int64)sub_14000600C;
      }
      result = 0;
    }
  }
  return result;
}
// 14000600C: using guessed type __int64 __fastcall sub_14000600C();
// 140006CD0: using guessed type __int64 __fastcall WdfVersionBind(_QWORD, _QWORD, _QWORD, _QWORD);
// 14000A108: using guessed type __int64 (*qword_14000A108)(void);
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;
// 14000A120: using guessed type __int64 qword_14000A120;
// 14000A128: using guessed type __int64 qword_14000A128;

//----- (0000000140006014) ----------------------------------------------------
__int64 sub_140006014()
{
  if ( qword_14000A108 && qword_14000A108 != sub_140006014 )
    qword_14000A108();
  return sub_140005E88();
}
// 14000A108: invalid function type has been ignored
// 14000A108: using guessed type __int64 (*qword_14000A108)(void);

//----- (000000014000603C) ----------------------------------------------------
__int64 sub_14000603C()
{
  __int64 result; // rax

  if ( &unk_14000A090 <= &unk_14000A0A0 )
    result = 0i64;
  else
    result = 3221225595i64;
  return result;
}

//----- (00000001400060A8) ----------------------------------------------------
__int64 __fastcall sub_1400060A8(__int64 a1)
{
  __int64 result; // rax
  _QWORD *i; // rbx
  __int64 (__fastcall *v4)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *); // rax

  result = 0i64;
  if ( &unk_14000A070 > (_UNKNOWN *)&qword_14000A080 )
    return 3221225595i64;
  for ( i = &qword_14000A080; i < &qword_14000A080; i += 10 )
  {
    if ( *(_DWORD *)i != 80 )
      return 3221225476i64;
    v4 = (__int64 (__fastcall *)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *))i[7];
    off_14000A088 = i;
    if ( v4 )
      result = v4(WdfVersionBindClass, a1, qword_14000A110, i);
    else
      result = WdfVersionBindClass(a1, qword_14000A110, i);
    if ( (int)result < 0 )
      return result;
  }
  return result;
}
// 140006CDC: using guessed type __int64 __fastcall WdfVersionBindClass(_QWORD, _QWORD, _QWORD);
// 14000A088: using guessed type void *off_14000A088;
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (0000000140006140) ----------------------------------------------------
void *__fastcall sub_140006140(__int64 a1)
{
  void *result; // rax
  _QWORD *v2; // rbx
  __int64 (__fastcall *v4)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *); // rax

  result = off_14000A088;
  v2 = &qword_14000A080;
  if ( off_14000A088 != &unk_14000A070 && &qword_14000A080 <= off_14000A088 )
  {
    do
    {
      v4 = (__int64 (__fastcall *)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *))v2[8];
      if ( v4 )
        result = (void *)v4(WdfVersionUnbindClass, a1, qword_14000A110, v2);
      else
        result = (void *)WdfVersionUnbindClass(a1, qword_14000A110, v2);
      v2 += 10;
    }
    while ( v2 <= off_14000A088 );
  }
  return result;
}
// 140006CE2: using guessed type __int64 __fastcall WdfVersionUnbindClass(_QWORD, _QWORD, _QWORD);
// 14000A088: using guessed type void *off_14000A088;
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (00000001400061D0) ----------------------------------------------------
char __fastcall sub_1400061D0(__int64 a1, int a2)
{
  char v2; // r8
  unsigned __int16 v3; // r9

  v2 = 1;
  v3 = 0;
  while ( *(_DWORD *)(32i64 * v3 + a1 + 16) == a2 )
  {
    if ( ++v3 >= 5u )
      return v2;
  }
  return 0;
}

//----- (0000000140006200) ----------------------------------------------------
void __fastcall sub_140006200(__int64 a1, __int64 a2, _BYTE *a3, int a4, void (*a5)(const char *, ...))
{
  int v5; // er9
  int v6; // er9

  v5 = a4 - 1;
  if ( v5 )
  {
    v6 = v5 - 1;
    if ( v6 )
    {
      if ( v6 == 1 )
        sub_140006978(a1, a2, a5);
      else
        *(_DWORD *)(a1 + 516) = 16;
    }
    else
    {
      sub_140006750(a1, a2, (void (__fastcall *)(const char *))a5);
    }
  }
  else
  {
    sub_140006634(a1, a2, a3);
  }
}

//----- (000000014000623C) ----------------------------------------------------
void *__fastcall sub_14000623C(_DWORD *a1, int a2, int a3, __int64 (__fastcall *a4)(const char *))
{
  void *result; // rax
  int v5; // edx

  if ( !a3 )
    return sub_1400065F0(a1, a4);
  v5 = a2 - 2;
  if ( !v5 )
    return sub_1400068A4(a1, (void (__fastcall *)(const char *))a4);
  if ( v5 == 1 )
    return sub_140006BB4(a1, (void (__fastcall *)(const char *))a4);
  a1[129] = 16;
  return result;
}

//----- (0000000140006270) ----------------------------------------------------
__int64 __fastcall sub_140006270(__int64 a1, int a2)
{
  __int64 v2; // r8
  int v3; // edx

  v2 = *(__int16 *)(a1 + 100);
  v3 = 16 * a2;
  *(_DWORD *)(a1 + 96) += v3 - *(_DWORD *)(a1 + 4 * v2);
  *(_DWORD *)(a1 + 4 * v2) = v3;
  if ( (__int16)++*(_WORD *)(a1 + 100) >= 24 )
    *(_WORD *)(a1 + 100) = 0;
  return (unsigned int)((int)(((int)((unsigned __int64)(715827883i64 * *(int *)(a1 + 96)) >> 32) >> 2)
                            + ((unsigned int)((unsigned __int64)(715827883i64 * *(int *)(a1 + 96)) >> 32) >> 31)
                            + 8) >> 4);
}

//----- (00000001400062B4) ----------------------------------------------------
char __fastcall sub_1400062B4(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
{
  char result; // al

  if ( !a1[128] )
  {
    if ( (unsigned int)(a1[129] - 1) > 1 )
    {
      a1[129] = 0;
      a1[131] = 0;
    }
    a1[128] = 1;
  }
  sub_14000656C(a1, a2, a3, a4);
  result = sub_1400061D0((__int64)a2, 0);
  if ( result )
  {
    if ( a4 )
      result = ((__int64 (__fastcall *)(const char *))a4)("RecognizerAddData - all fingers up");
    a1[8] = 0;
    a1[128] = 0;
    a1[130] = 0;
  }
  return result;
}

//----- (0000000140006340) ----------------------------------------------------
__int64 __fastcall sub_140006340(__int64 a1, int a2)
{
  __int64 result; // rax

  if ( a2 != 1 && a2 != 8 && a2 != 13 )
  {
    result = *(unsigned int *)(a1 + 504);
    *(_DWORD *)(a1 + 508) = result;
    *(_DWORD *)(a1 + 504) = a2;
  }
  return result;
}

//----- (0000000140006368) ----------------------------------------------------
__int64 __fastcall sub_140006368(unsigned int a1, unsigned int *a2)
{
  __int64 result; // rax

  result = 87i64;
  *a2 = 0;
  if ( a1 <= 0xD )
  {
    *a2 = a1;
    result = 0i64;
  }
  return result;
}

//----- (0000000140006380) ----------------------------------------------------
void *__fastcall sub_140006380(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *))
{
  void *result; // rax

  if ( a3 )
    a3("RecognizerInitialize Entry");
  *(_DWORD *)(a1 + 512) = 0;
  *(_DWORD *)(a1 + 516) = 0;
  *(_DWORD *)(a1 + 508) = 0;
  *(_DWORD *)(a1 + 504) = 0;
  *(_DWORD *)(a1 + 32) = 0;
  *(_QWORD *)(a1 + 496) = 0i64;
  *(_QWORD *)a1 = a2;
  *(_DWORD *)(a1 + 16) = 500;
  *(_DWORD *)(a1 + 20) = 200;
  *(_DWORD *)(a1 + 8) = (int)a2 / 10;
  *(_DWORD *)(a1 + 12) = a2 - (int)a2 / 10;
  *(_DWORD *)(a1 + 24) = 72900;
  *(_DWORD *)(a1 + 28) = 1444;
  *(_BYTE *)(a1 + 488) = 0;
  result = memset((void *)(a1 + 40), 0, 0x1C0ui64);
  if ( a3 )
    result = (void *)((__int64 (__fastcall *)(const char *))a3)("RecognizerInitialize Exit");
  return result;
}

//----- (000000014000643C) ----------------------------------------------------
void __fastcall sub_14000643C(unsigned int *a1, unsigned int *a2, void (*a3)(const char *, ...))
{
  unsigned int v4; // eax
  unsigned int v5; // er8
  int v6; // eax

  if ( a1[129] != 1 )
  {
    if ( a1[129] == 2 )
    {
      v4 = a1[131];
      if ( v4 == 8 || v4 == 13 )
      {
        *a2 = v4;
        a1[131] = 0;
        return;
      }
    }
    else if ( a1[129] == 8 )
    {
      *a2 = a1[131];
      return;
    }
LABEL_14:
    *a2 = 0;
    return;
  }
  v5 = a1[131];
  if ( v5 > 9 || (v6 = 548, !_bittest(&v6, v5)) )
  {
    if ( v5 - 10 <= 2 )
    {
      *a2 = v5;
      return;
    }
    goto LABEL_14;
  }
  *a2 = v5;
  if ( a3 )
    a3("Detected GestureType_XXXFingerStart with %d fingers", a1[8]);
}

//----- (00000001400064BC) ----------------------------------------------------
__int64 __fastcall sub_1400064BC(__int64 a1)
{
  __int64 result; // rax

  result = (unsigned int)(*(_DWORD *)(a1 + 516) - 1);
  if ( (unsigned int)result > 1 )
  {
    result = 0i64;
    *(_QWORD *)(a1 + 512) = 0i64;
    *(_DWORD *)(a1 + 524) = 0;
  }
  return result;
}

//----- (00000001400064DC) ----------------------------------------------------
__int64 __fastcall sub_1400064DC(__int64 a1, __int64 *a2, int a3, int a4, void (__fastcall *a5)(const char *))
{
  int v5; // er9
  int v6; // er9
  __int64 result; // rax

  v5 = a4 - 1;
  if ( !v5 )
    return sub_1400066E0(a1, (__int64)a2, a5);
  v6 = v5 - 1;
  if ( !v6 )
    return sub_1400068E4(a3, a1, a2, (__int64 (__fastcall *)(const char *))a5);
  if ( v6 == 1 )
    return sub_140006BF8(a3, a1, a2, (__int64 (__fastcall *)(const char *))a5);
  *(_DWORD *)(a1 + 516) = 16;
  return result;
}

//----- (000000014000652C) ----------------------------------------------------
__int64 __fastcall sub_14000652C(__int64 a1, __int64 *a2)
{
  __int64 result; // rax

  *(_QWORD *)(a1 + 24) = a2[2];
  result = *a2;
  *(_QWORD *)(a1 + 32) = *a2;
  return result;
}

//----- (000000014000653C) ----------------------------------------------------
__int64 __fastcall sub_14000653C(__int64 a1, __int64 *a2)
{
  __int64 result; // rax

  *(_WORD *)a1 = *((_WORD *)a2 + 12);
  *(_QWORD *)(a1 + 8) = a2[2];
  *(_QWORD *)(a1 + 16) = *a2;
  *(_QWORD *)(a1 + 24) = a2[2];
  *(_QWORD *)(a1 + 32) = *a2;
  result = *a2;
  *(_QWORD *)(a1 + 40) = *a2;
  return result;
}

//----- (000000014000656C) ----------------------------------------------------
void __fastcall sub_14000656C(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
{
  int v4; // er11
  _DWORD *v6; // rdx
  __int64 v7; // rdi
  bool v8; // zf
  int v9; // er10
  int v10; // edx

  v4 = 0;
  v6 = a2 + 2;
  v7 = 5i64;
  do
  {
    v8 = *v6 == 1;
    v9 = v4 + 1;
    v6 += 8;
    if ( !v8 )
      v9 = v4;
    v4 = v9;
    --v7;
  }
  while ( v7 );
  v10 = a1[8];
  a1[8] = v9;
  if ( v9 <= v10 )
  {
    if ( v9 >= v10 )
      sub_140006200((__int64)a1, (__int64)a2, a3, v9, a4);
    else
      sub_14000623C(a1, v10, v9, (__int64 (__fastcall *)(const char *))a4);
  }
  else
  {
    sub_1400064DC((__int64)a1, a2, v10, v9, (void (__fastcall *)(const char *))a4);
  }
}

//----- (00000001400065E4) ----------------------------------------------------
__int64 __fastcall sub_1400065E4(__int64 a1, _DWORD *a2)
{
  __int64 result; // rax

  *(_DWORD *)(a1 + 40) += *a2;
  result = (unsigned int)a2[1];
  *(_DWORD *)(a1 + 44) += result;
  return result;
}

//----- (00000001400065F0) ----------------------------------------------------
void *__fastcall sub_1400065F0(_DWORD *a1, __int64 (__fastcall *a2)(const char *))
{
  void *result; // rax

  a1[129] = 8;
  a1[131] = 1;
  result = memset(a1 + 10, 0, 0xF0ui64);
  if ( a2 )
    result = (void *)a2("Detected GestureType_AllFingerEnd");
  return result;
}

//----- (0000000140006634) ----------------------------------------------------
__int64 __fastcall sub_140006634(__int64 a1, __int64 a2, _BYTE *a3)
{
  __int64 result; // rax
  __int64 *v5; // r10
  int v6; // ebx
  int v7; // ecx

  if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 524) == 2 )
      *(_DWORD *)(a1 + 524) = 0;
    result = *(unsigned __int16 *)(a1 + 40);
    v5 = (__int64 *)(a2 + 8);
    if ( *(_WORD *)(a2 + 32) != (_WORD)result )
      goto LABEL_13;
    v6 = *(_DWORD *)(a1 + 56);
    v7 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 60);
    if ( (*(_DWORD *)v5 - v6) * (*(_DWORD *)v5 - v6) + v7 * v7 > *(_DWORD *)(a1 + 24) )
    {
      *(_DWORD *)(a1 + 516) = 8;
      *(_DWORD *)(a1 + 524) = 4;
      return result;
    }
    if ( v6 < *(_DWORD *)(a1 + 8) || v6 > *(_DWORD *)(a1 + 12) || *a3 || a3[1] || a3[2] )
    {
LABEL_13:
      *(_DWORD *)(a1 + 524) = 0;
      *(_DWORD *)(a1 + 516) = 16;
    }
    else
    {
      result = sub_14000652C(a1 + 40, v5);
    }
  }
  return result;
}

//----- (00000001400066E0) ----------------------------------------------------
__int64 __fastcall sub_1400066E0(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *))
{
  unsigned __int64 v5; // r8
  unsigned __int64 v6; // rax

  if ( a3 )
    a3("One finger gesture start");
  v5 = *(int *)(a1 + 16);
  *(_DWORD *)(a1 + 516) = 1;
  *(_DWORD *)(a1 + 524) = 2;
  v6 = *(_QWORD *)(a2 + 24) - *(_QWORD *)(a1 + 496);
  *(_QWORD *)(a1 + 496) = *(_QWORD *)(a2 + 24);
  *(_BYTE *)(a1 + 488) = v6 < v5;
  return sub_14000653C(a1 + 40, (__int64 *)(a2 + 8));
}

//----- (0000000140006750) ----------------------------------------------------
void __fastcall sub_140006750(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *))
{
  int v4; // ecx
  int v5; // edi
  int v6; // er11
  int v7; // eax
  int v8; // edi
  int v9; // ecx
  int v10; // er11
  const char *v11; // rcx
  unsigned __int64 v12; // r10
  unsigned __int64 v13; // rcx
  unsigned __int64 v14; // rbx

  if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 524) == 5 )
      *(_DWORD *)(a1 + 524) = 0;
    if ( *(_WORD *)(a1 + 40) == *(_WORD *)(a2 + 32) && *(_WORD *)(a1 + 88) == *(_WORD *)(a2 + 64) )
    {
      v4 = *(_DWORD *)(a2 + 8) - *(_DWORD *)(a1 + 56);
      v5 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 60);
      v6 = *(_DWORD *)(a2 + 44) - *(_DWORD *)(a1 + 108);
      v7 = *(_DWORD *)(a1 + 24);
      v8 = v4 * v4 + v5 * v5;
      v9 = *(_DWORD *)(a2 + 40) - *(_DWORD *)(a1 + 104);
      v10 = v9 * v9 + v6 * v6;
      if ( v8 > v7 && v10 > v7 )
      {
        *(_DWORD *)(a1 + 516) = 8;
        *(_DWORD *)(a1 + 524) = 7;
        if ( !a3 )
          return;
        v11 = "Detected GestureType_TwoFingersDrag (distance)";
        goto LABEL_16;
      }
      v12 = *(_QWORD *)(a2 + 24) - *(_QWORD *)(a1 + 48);
      v13 = *(_QWORD *)(a2 + 56) - *(_QWORD *)(a1 + 96);
      if ( *(_QWORD *)(a2 + 24) != *(_QWORD *)(a1 + 48) && v13 )
      {
        v14 = *(int *)(a1 + 28);
        if ( v8 / v12 > v14 && v10 / v13 > v14 )
        {
          *(_DWORD *)(a1 + 516) = 8;
          *(_DWORD *)(a1 + 524) = 7;
          if ( !a3 )
            return;
          v11 = "Detected GestureType_TwoFingersDrag (velocity)";
          goto LABEL_16;
        }
        if ( v12 > 0x64 || v13 > 0x64 )
        {
          *(_DWORD *)(a1 + 516) = 8;
          *(_DWORD *)(a1 + 524) = 7;
          if ( a3 )
          {
            v11 = "Detected GestureType_TwoFingersHeld";
LABEL_16:
            a3(v11);
            return;
          }
        }
      }
    }
    else
    {
      *(_DWORD *)(a1 + 516) = 16;
    }
  }
}

//----- (00000001400068A4) ----------------------------------------------------
void *__fastcall sub_1400068A4(_DWORD *a1, void (__fastcall *a2)(const char *))
{
  if ( a2 )
    a2("Detected GestureType_TwoFingerEnd");
  a1[129] = 2;
  a1[131] = 8;
  return memset(a1 + 22, 0, 0x30ui64);
}

//----- (00000001400068E4) ----------------------------------------------------
__int64 __fastcall sub_1400068E4(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *))
{
  __int64 result; // rax

  if ( *(_DWORD *)(a2 + 516) <= 1u )
  {
    if ( a4 )
      result = a4("Two finger gesture start");
    if ( a1 == 1 )
    {
      if ( (unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64 )
      {
        *(_DWORD *)(a2 + 524) = 0;
        *(_DWORD *)(a2 + 516) = 16;
        return result;
      }
    }
    else
    {
      sub_14000653C(a2 + 40, a3 + 1);
    }
    result = sub_14000653C(a2 + 88, a3 + 5);
    *(_DWORD *)(a2 + 516) = 1;
    *(_DWORD *)(a2 + 524) = 5;
  }
  return result;
}

//----- (0000000140006978) ----------------------------------------------------
void __fastcall sub_140006978(__int64 a1, __int64 a2, void (*a3)(const char *, ...))
{
  int v3; // ebx
  __int16 v6; // ax
  _DWORD *v7; // r10
  _DWORD *v8; // r11
  __int16 v9; // ax
  unsigned int v10; // er12
  unsigned int v11; // eax
  int v12; // ecx
  int v13; // er9
  int v14; // er8
  int v15; // edx
  int v16; // er14
  int v17; // er15
  int v18; // ecx
  __int64 v19; // rsi
  __int64 v20; // rbx
  unsigned __int64 v21; // [rsp+20h] [rbp-30h] BYREF
  __int64 v22; // [rsp+28h] [rbp-28h]
  __int64 v23; // [rsp+30h] [rbp-20h]
  __int64 *v24; // [rsp+38h] [rbp-18h]
  __int64 *v25; // [rsp+40h] [rbp-10h]
  __int64 *v26; // [rsp+48h] [rbp-8h]
  unsigned __int64 v27; // [rsp+90h] [rbp+40h] BYREF
  __int64 v28; // [rsp+A8h] [rbp+58h] BYREF

  v3 = 0;
  if ( *(_DWORD *)(a1 + 524) == 9 )
    *(_DWORD *)(a1 + 524) = 0;
  if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 520) == 1 )
    {
      v6 = *(_WORD *)(a2 + 32);
      v7 = (_DWORD *)(a2 + 40);
      v8 = (_DWORD *)(a2 + 72);
      v24 = (__int64 *)(a2 + 8);
      v25 = (__int64 *)(a2 + 40);
      v26 = (__int64 *)(a2 + 72);
      v23 = a1 + 40;
      if ( *(_WORD *)(a1 + 40) == v6
        && *(_WORD *)(a1 + 88) == *(_WORD *)(a2 + 64)
        && (v9 = *(_WORD *)(a2 + 96), v22 = a1 + 136, *(_WORD *)(a1 + 136) == v9) )
      {
        v10 = 0;
        v27 = 0i64;
        v11 = 0;
        v28 = 0i64;
        v21 = 0i64;
        if ( *(_QWORD *)(a1 + 64) && *(_QWORD *)(a1 + 112) && *(_QWORD *)(a1 + 160) )
        {
          v12 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 76);
          v13 = *(_DWORD *)(a2 + 8) - *(_DWORD *)(a1 + 72);
          v14 = *v7 - *(_DWORD *)(a1 + 120);
          v15 = *v8 - *(_DWORD *)(a1 + 168);
          HIDWORD(v28) = v7[1] - *(_DWORD *)(a1 + 124);
          v21 = __PAIR64__(v8[1] - *(_DWORD *)(a1 + 172), v15);
          v27 = __PAIR64__(v12, v13);
          LODWORD(v28) = v14;
          v10 = sub_140006270(a1 + 280, v13 + v14 + v15);
          v11 = sub_140006270(a1 + 384, HIDWORD(v27) + HIDWORD(v21) + HIDWORD(v28));
        }
        v16 = v10 * v10;
        v17 = v11 * v11;
        v18 = v11 * v11 + v10 * v10;
        if ( a3 )
        {
          a3("3 fingers, x: %d, y: %d - avg: %d", v10, v11, (unsigned int)v18, v21);
          v18 = v17 + v16;
        }
        if ( v18 <= 50 )
        {
          v20 = v22;
          v19 = v23;
          *(_DWORD *)(a1 + 524) = 10;
        }
        else
        {
          v19 = a1 + 40;
          LOBYTE(v3) = v16 <= v17;
          *(_DWORD *)(a1 + 524) = v3 + 11;
          sub_1400065E4(a1 + 40, &v27);
          sub_1400065E4(a1 + 88, &v28);
          v20 = a1 + 136;
          sub_1400065E4(a1 + 136, &v21);
        }
        sub_14000652C(v19, v24);
        sub_14000652C(a1 + 88, v25);
        sub_14000652C(v20, v26);
      }
      else
      {
        *(_DWORD *)(a1 + 516) = 16;
      }
    }
    else if ( a3 )
    {
      a3("3 fingers, but not slow mode");
    }
  }
}

//----- (0000000140006BB4) ----------------------------------------------------
void *__fastcall sub_140006BB4(_DWORD *a1, void (__fastcall *a2)(const char *))
{
  if ( a2 )
    a2("Three finger gesture end");
  a1[129] = 2;
  a1[131] = 13;
  return memset(a1 + 34, 0, 0x30ui64);
}

//----- (0000000140006BF8) ----------------------------------------------------
__int64 __fastcall sub_140006BF8(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *))
{
  __int64 result; // rax
  int v8; // edi

  if ( *(_DWORD *)(a2 + 516) <= 1u )
  {
    if ( a4 )
      result = a4("Three finger gesture start");
    if ( a1 )
    {
      v8 = a1 - 1;
      if ( v8 )
      {
        if ( v8 == 1
          && ((unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64
           || (unsigned __int64)(a3[7] - *(_QWORD *)(a2 + 96)) > 0x64) )
        {
          goto LABEL_11;
        }
        goto LABEL_14;
      }
      if ( (unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64 )
      {
LABEL_11:
        *(_DWORD *)(a2 + 524) = 0;
        *(_DWORD *)(a2 + 516) = 16;
        return result;
      }
    }
    else
    {
      sub_14000653C(a2 + 40, a3 + 1);
    }
    sub_14000653C(a2 + 88, a3 + 5);
LABEL_14:
    result = sub_14000653C(a2 + 136, a3 + 9);
    *(_DWORD *)(a2 + 516) = 1;
    *(_DWORD *)(a2 + 524) = 9;
  }
  return result;
}

//----- (000000014000C000) ----------------------------------------------------
__int64 __fastcall sub_14000C000(__int64 a1)
{
  int v1; // ebx
  unsigned __int16 v2; // r9
  __int64 v3; // rdi
  __int64 v4; // rax
  int v6; // [rsp+20h] [rbp-E0h]
  _QWORD v7[12]; // [rsp+30h] [rbp-D0h] BYREF
  _QWORD v8[8]; // [rsp+90h] [rbp-70h] BYREF
  __int64 Dst[24]; // [rsp+D0h] [rbp-30h] BYREF
  __int64 v10; // [rsp+1A0h] [rbp+A0h] BYREF
  __int64 v11; // [rsp+1A8h] [rbp+A8h] BYREF
  char v12; // [rsp+1B0h] [rbp+B0h] BYREF

  v10 = a1;
  DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0xAu, (__int64)&unk_140009140);
  
  
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 1032))(qword_14000A110, v10);//WdfFdoInitSetFilter(DeviceInit_a1);//WdfPdoInitAllowForwardingRequestToParent(DeviceInit);WdfDeviceInitSetPowerPageable(DeviceInit);
  (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 456))(qword_14000A110, v10, 0i64);//WdfDeviceInitSetIoType(DeviceInit_14,WdfDeviceIoUndefined);
  memset(Dst, 0, 0x90ui64);
  Dst[5] = (__int64)sub_14000135C;//pnpPowerCallbacks_Dst.EvtDevicePrepareHardware=PTPFilterDevicePrepareHardware;
  Dst[6] = (__int64)sub_140001810;//pnpPowerCallbacks_Dst.EvtDeviceReleaseHardware= PTPFilterDeviceReleaseHardware;
  LODWORD(Dst[0]) = 144;
  (*(void (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 440))(qword_14000A110, v10, Dst);//WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit_14, &pnpPowerCallbacks_Dst);
  memset(v8, 0, 0x38ui64);
  v8[3] = 0x100000001i64;
  v8[6] = off_14000A018;
  LODWORD(v8[0]) = 56;
  v1 = (*(__int64 (__fastcall **)(__int64, __int64 *, _QWORD *, __int64 *))(qword_14000A118 + 600))(
         qword_14000A110,
         &v10,
         v8,
         &v11);
  if ( v1 >= 0 )
  {
    v3 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
           qword_14000A110,
           v11,
           off_14000A018);
    *(_QWORD *)(v3 + 8) = v11;
    v4 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 336))(qword_14000A110, v11);
    *(_BYTE *)(v3 + 908) = 0;
    *(_QWORD *)(v3 + 16) = v4;
    *(_BYTE *)(v3 + 920) = 0;
    memset(v7, 0, sizeof(v7));
    LODWORD(v7[10]) = -1;
    LODWORD(v7[1]) = 0;
    v7[5] = sub_1400034B8;//queueConfig_v11..EvtIoDeviceControl = PTPFilterEvtIoDeviceControl;
    v7[3] = sub_1400039F0;//queueConfig_v11.EvtIoRead = PTPFilterEvtIoRead;
    v7[0] = 0x200000060i64;
    BYTE5(v7[1]) = 1;
    v1 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD *, _QWORD, char *))(qword_14000A118 + 1216))(
           qword_14000A110,
           v11,
           v7,
           0i64,
           &v12);
    if ( v1 >= 0 )
    {
      memset((char *)&v7[1] + 4, 0, 0x54ui64);
      LODWORD(v7[1]) = 0;
      v7[0] = 0x300000060i64;
      v1 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD *, _QWORD, __int64))(qword_14000A118 + 1216))(
             qword_14000A110,
             v11,
             v7,
             0i64,
             v3 + 32);//ResetNotificationQueue
      if ( v1 >= 0 )
      {
        memset((char *)&v7[1] + 4, 0, 0x54ui64);
        LODWORD(v7[1]) = 0;
        v7[0] = 0x300000060i64;
        v1 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD *, _QWORD, __int64))(qword_14000A118 + 1216))(
               qword_14000A110,
               v11,
               v7,
               0i64,
               v3 + 56);//ReadReportQueue
        if ( v1 >= 0 )
        {
          sub_140001038((_QWORD *)v3);
          v1 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64))(qword_14000A118 + 2520))(
                 qword_14000A110,
                 0i64,
                 v3 + 912);//status_v1=WdfSpinLockCreate( NULL, pDeviceContext_v3->ReadLoopSpinLock_912);
          if ( v1 >= 0 )
          {
            v1 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64))(qword_14000A118 + 2520))(
                   qword_14000A110,
                   0i64,
                   v3 + 960);//status_v1=WdfSpinLockCreate( NULL, pDeviceContext_v3->ProcessedBufferSpinLock_960);
            if ( v1 >= 0 )
            {
              v1 = (*(__int64 (__fastcall **)(__int64, __int64, void *, _QWORD))(qword_14000A118 + 616))(//Status_v8=WdfDeviceCreateDeviceInterface( 
                     qword_14000A110,
                     v11,
                     &unk_140009100,
                     0i64);
              if ( v1 >= 0 )
              {
                LOBYTE(v6) = 1;
                (*(void (__fastcall **)(__int64, __int64, void *, _QWORD, int))(qword_14000A118 + 624))(//void WdfDeviceSetDeviceInterfaceState(
                  qword_14000A110,
                  v11,
                  &unk_140009100,
                  0i64,
                  v6);
                goto LABEL_17;
              }
              DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
              DbgPrint("WdfDeviceCreateDeviceInterface failed 0x%x", (unsigned int)v1);
              DbgPrint("\n");
              v2 = 17;
            }
            else
            {
              DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
              DbgPrint("WdfSpinLockCreate for ProcessedBufferSpinLock failed 0x%x", (unsigned int)v1);
              DbgPrint("\n");
              v2 = 16;
            }
          }
          else
          {
            DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
            DbgPrint("WdfSpinLockCreate for ReadLoopSpinLock failed 0x%x", (unsigned int)v1);
            DbgPrint("\n");
            v2 = 15;
          }
        }
        else
        {
          DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
          DbgPrint("WdfIoQueueCreate failed 0x%x", (unsigned int)v1);
          DbgPrint("\n");
          v2 = 14;
        }
      }
      else
      {
        DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
        DbgPrint("WdfIoQueueCreate failed 0x%x", (unsigned int)v1);
        DbgPrint("\n");
        v2 = 13;
      }
    }
    else
    {
      DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
      DbgPrint("WdfIoQueueCreate failed 0x%x", (unsigned int)v1);
      DbgPrint("\n");
      v2 = 12;
    }
  }
  else
  {
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfDeviceCreate failed 0x%x", (unsigned int)v1);
    DbgPrint("\n");
    v2 = 11;
  }
  sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 2u, v2, (__int64)&unk_140009140, v1);
LABEL_17:
  DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 2u, 0x12u, (__int64)&unk_140009140);
  return (unsigned int)v1;
}
// 14000C4CA: variable 'v6' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000C52C) ----------------------------------------------------
__int64 __fastcall sub_14000C52C(__int64 a1, __int64 a2)//NTSTATUS PTPFilterEvtDeviceAdd((IN WDFDRIVER Driver_a1, IN PWDFDEVICE_INIT DeviceInit_a2)
{
  DbgPrint("[PTP] %s : ", "PTPFilterEvtDeviceAdd");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 3u, 0xDu, (__int64)&unk_140009150);
  LODWORD(a2) = sub_14000C000(a2);//status_v3 = PTPFilterCreateDevice(DeviceInit_a2);
  DbgPrint("[PTP] %s : ", "PTPFilterEvtDeviceAdd");
  DbgPrint("Exit");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 3u, 0xEu, (__int64)&unk_140009150);
  return (unsigned int)a2;
}

//----- (000000014000C5F0) ----------------------------------------------------
void __fastcall sub_14000C5F0(__int64 a1)
{
  __int64 v2; // rax

  DbgPrint("[PTP] %s : ", "PTPFilterEvtDriverContextCleanup");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 3u, 0xFu, (__int64)&unk_140009150);
  v2 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 944))(qword_14000A110, a1);
  sub_14000C670(v2);
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000C670) ----------------------------------------------------
void __fastcall sub_14000C670(__int64 a1)
{
  PDEVICE_OBJECT v1; // rbx

  v1 = DeviceObject;
  if ( DeviceObject != (PDEVICE_OBJECT)&DeviceObject )
  {
    if ( dword_14000A0E8 == 4 )
    {
      while ( v1 )
      {
        if ( v1->Vpb )
          qword_14000A0D0();
        v1 = v1->NextDevice;
      }
    }
    else if ( dword_14000A0E8 == 2 )
    {
      IoWMIRegistrationControl(DeviceObject, 0x80000002);
    }
    WppAutoLogStop(DeviceObject, a1);
    DeviceObject = (PDEVICE_OBJECT)&DeviceObject;
  }
}
// 1400061C3: using guessed type __int64 __fastcall WppAutoLogStop(_QWORD, _QWORD);
// 14000A0D0: using guessed type __int64 (*qword_14000A0D0)(void);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000C6F4) ----------------------------------------------------
void __fastcall sub_14000C6F4(__int64 a1, __int64 a2)
{
  struct _DEVICE_OBJECT *v2; // rbx
  _DRIVER_OBJECT *v5; // rcx

  v2 = &stru_14000A340;
  if ( DeviceObject != &stru_14000A340 )
  {
    DeviceObject = &stru_14000A340;
    if ( dword_14000A0E8 == 4 )
    {
      do
      {
        v5 = v2->DriverObject;
        v2->Vpb = 0i64;
        qword_14000A0D8(v5, 0i64, sub_140001AB0, v2, &v2->Vpb);
        v2 = v2->NextDevice;
      }
      while ( v2 );
    }
    else if ( dword_14000A0E8 == 2 )
    {
      *(_QWORD *)&stru_14000A340.Type = sub_14000C894;
      IoWMIRegistrationControl(&stru_14000A340, 0x80010001);
    }
    WppAutoLogStart(DeviceObject, a1, a2);
  }
}
// 14000A0D8: invalid function type has been ignored
// 1400061BD: using guessed type __int64 __fastcall WppAutoLogStart(_QWORD, _QWORD, _QWORD);
// 14000A0D8: using guessed type __int64 (__fastcall *qword_14000A0D8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000C79C) ----------------------------------------------------
__int64 (*sub_14000C79C())(void)
{
  __int64 (*result)(void); // rax
  _UNICODE_STRING DestinationString; // [rsp+20h] [rbp-10h] BYREF
  unsigned int v2; // [rsp+40h] [rbp+10h] BYREF

  v2 = 0;
  RtlInitUnicodeString(&DestinationString, L"PsGetVersion");
  qword_14000A0E0 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))MmGetSystemRoutineAddress(&DestinationString);
  RtlInitUnicodeString(&DestinationString, L"WmiTraceMessage");
  qword_14000A0C8 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD))MmGetSystemRoutineAddress(&DestinationString);
  RtlInitUnicodeString(&DestinationString, L"WmiQueryTraceInformation");
  qword_14000A0C0 = (__int64)MmGetSystemRoutineAddress(&DestinationString);
  result = (__int64 (*)(void))qword_14000A0E0;
  dword_14000A0E8 = 2;
  if ( qword_14000A0E0 )
    result = (__int64 (*)(void))qword_14000A0E0(&v2, 0i64, 0i64, 0i64);
  if ( v2 >= 6 )
  {
    RtlInitUnicodeString(&DestinationString, L"EtwRegisterClassicProvider");
    result = (__int64 (*)(void))MmGetSystemRoutineAddress(&DestinationString);
    qword_14000A0D8 = (__int64)result;
    if ( result )
    {
      RtlInitUnicodeString(&DestinationString, L"EtwUnregister");
      result = (__int64 (*)(void))MmGetSystemRoutineAddress(&DestinationString);
      qword_14000A0D0 = result;
      dword_14000A0E8 = 4;
    }
  }
  return result;
}
// 14000A0C0: using guessed type __int64 qword_14000A0C0;
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0D0: using guessed type __int64 (*qword_14000A0D0)(void);
// 14000A0D8: using guessed type __int64 qword_14000A0D8;
// 14000A0E0: using guessed type __int64 (__fastcall *qword_14000A0E0)(_QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000C894) ----------------------------------------------------
__int64 __fastcall sub_14000C894(unsigned __int8 a1, __int64 a2, unsigned int a3, unsigned int *a4, __int64 a5, unsigned int *a6)
{
  unsigned int *v6; // r13
  unsigned int v7; // ebx
  __int64 v10; // rsi
  unsigned int v11; // edi
  __int64 v12; // rax
  const void **v13; // r15
  unsigned int v14; // ebp
  unsigned int v15; // er12
  _WORD *v16; // rcx
  _DWORD *v17; // r14
  __int64 v18; // rcx
  __int128 v19; // xmm0
  __int64 v20; // rdi
  __int64 v21; // rax
  char v23; // [rsp+70h] [rbp+8h] BYREF

  v6 = a6;
  v7 = 0;
  *a6 = 0;
  if ( a1 <= 3u )
    return (unsigned int)-1073741808;
  if ( a1 > 5u )
  {
    if ( a1 <= 7u )
      return v7;
    if ( a1 == 8 )
    {
      v10 = a5;
      v11 = 0;
      v12 = a5;
      v13 = *(const void ***)(a5 + 32);
      do
      {
        v12 = *(_QWORD *)(v12 + 16);
        ++v11;
      }
      while ( v12 );
      if ( v11 > 0x3F )
        return (unsigned int)-1073741811;
      v14 = 32 * v11 + 24;
      if ( v13 )
      {
        v15 = 32 * v11 + 24;
        v14 += *(unsigned __int16 *)v13 + 2;
      }
      else
      {
        v15 = 0;
      }
      if ( v14 > a3 )
      {
        v7 = -1073741789;
        if ( a3 >= 4 )
        {
          *a4 = v14;
          *v6 = 4;
        }
      }
      else
      {
        memset(a4, 0, a3);
        *a4 = v14;
        a4[2] = v15;
        a4[4] = v11;
        if ( v13 )
        {
          v16 = (_WORD *)((char *)a4 + v15);
          *v16 = *(_WORD *)v13;
          memmove(v16 + 1, v13[1], *(unsigned __int16 *)v13);
        }
        if ( v11 )
        {
          v17 = a4 + 10;
          v18 = v11;
          do
          {
            v19 = *(_OWORD *)*(_QWORD *)(v10 + 8);
            *v17 = 528384;
            v17 += 8;
            *((_OWORD *)v17 - 3) = v19;
            *(_BYTE *)(v10 + 41) = 0;
            *(_DWORD *)(v10 + 44) = 0;
            v10 = *(_QWORD *)(v10 + 16);
            --v18;
          }
          while ( v18 );
        }
        *v6 = v14;
      }
      return v7;
    }
    return (unsigned int)-1073741808;
  }
  v20 = a5;
  if ( !a5 )
    return (unsigned int)-1073741163;
  if ( a3 < 0x30 )
    return (unsigned int)-1073741811;
  do
  {
    if ( RtlCompareMemory(*(const void **)(v20 + 8), a4 + 6, 0x10ui64) == 16 )
      break;
    v20 = *(_QWORD *)(v20 + 16);
  }
  while ( v20 );
  if ( !v20 )
    return (unsigned int)-1073741163;
  if ( a1 == 5 )
  {
    *(_BYTE *)(v20 + 41) = 0;
    *(_DWORD *)(v20 + 44) = 0;
    *(_QWORD *)(v20 + 24) = 0i64;
  }
  else
  {
    v21 = *((_QWORD *)a4 + 1);
    *(_QWORD *)(v20 + 24) = v21;
    if ( dword_14000A0E8 == 2 )
    {
      if ( !(unsigned int)qword_14000A0C0(3i64, &v23, 4i64, &a6, a4) )
        *(_BYTE *)(v20 + 41) = v23;
      v7 = qword_14000A0C0(2i64, v20 + 44, 4i64, &a6, a4);
    }
    else
    {
      *(_DWORD *)(v20 + 44) = HIDWORD(v21);
      *(_BYTE *)(v20 + 41) = BYTE2(v21);
    }
  }
  return v7;
}
// 14000A0C0: invalid function type has been ignored
// 14000A0C0: using guessed type __int64 (__fastcall *qword_14000A0C0)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000D000) ----------------------------------------------------
__int64 __fastcall sub_14000D000(__int64 a1, __int64 a2)//FxDriverEntryWorker(DriverObject, RegistryPath)
{
  int v4; // ebx
  __int64 v6; // [rsp+28h] [rbp-70h]
  __int64 v7[2]; // [rsp+30h] [rbp-68h] BYREF
  __int128 v8; // [rsp+40h] [rbp-58h]
  __int64 Dst[8]; // [rsp+50h] [rbp-48h] BYREF

  stru_14000A340.Timer = (PIO_TIMER)1;
  *(_QWORD *)&stru_14000A340.Type = 0i64;
  stru_14000A340.DriverObject = (_DRIVER_OBJECT *)&unk_140009120;
  stru_14000A340.NextDevice = 0i64;
  stru_14000A340.CurrentIrp = 0i64;
  stru_14000A340.DeviceExtension = 0i64;
  stru_14000A340.DeviceType = 0;
  sub_14000C79C();
  stru_14000A340.CurrentIrp = 0i64;
  sub_14000C6F4(a1, a2);
  DbgPrint("[PTP] %s : ", "DriverEntry");
  DbgPrint("Entry");
  DbgPrint("\n");
  sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 3u, 0xAu, (__int64)&unk_140009150);
  
  
  memset(Dst, 0, 0x38ui64);
  Dst[1] = (__int64)sub_14000C5F0;//attributes_Dst.EvtCleanupCallback=EvtDriverContextCleanup
  v7[1] = (__int64)sub_14000C52C;//config_v7.EvtDriverDeviceAdd=PTPFilterEvtDeviceAdd_sub_14000C52C;
  LODWORD(Dst[0]) = 56;
  Dst[3] = 0x100000001i64;
  v7[0] = 32i64;
  v8 = 0i64;
  v4 = (*(__int64 (__fastcall **)(__int64, __int64, __int64, __int64 *, __int64 *, _QWORD))(qword_14000A118 + 928))(
         qword_14000A110,
         a1,
         a2,
         Dst,
         v7,
         0i64);
  DbgPrint("[PTP] %s : ", "DriverEntry");
  if ( v4 >= 0 )
  {
    DbgPrint("Exit");
    DbgPrint("\n");
    sub_14000129C((__int64)DeviceObject->DeviceExtension, 4u, 3u, 0xCu, (__int64)&unk_140009150);
  }
  else
  {
    DbgPrint("WdfDriverCreate failed 0x%x", (unsigned int)v4);
    DbgPrint("\n");
    LODWORD(v6) = v4;
    sub_1400019C0((__int64)DeviceObject->DeviceExtension, 2u, 3u, 0xBu, (__int64)&unk_140009150, v6);
    sub_14000C670(a1);
  }
  return (unsigned int)v4;
}
// 14000D196: variable 'v6' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

// nfuncs=117 queued=91 decompiled=91 lumina nreq=0 worse=0 better=0
// ALL OK, 91 function(s) have been successfully decompiled
